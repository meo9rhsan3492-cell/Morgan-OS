<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morgan 营销操作系统 v18.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS for Excel Parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- PDF.js for PDF Parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- jsPDF for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Supabase for Auth & Database -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Set worker src for PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a', 950: '#020617' }
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            /* Deep Space Gradient + Subtle Glow */
            --bg-primary: radial-gradient(circle at 50% 10%, rgba(59, 130, 246, 0.15) 0%, transparent 50%), linear-gradient(135deg, #0f172a 0%, #020617 100%);
            --bg-secondary: rgba(30, 41, 59, 0.4);
            /* Glass Sidebar */
            --bg-panel: rgba(15, 23, 42, 0.6);
            /* Glass Panel */
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border-primary: rgba(148, 163, 184, 0.1);
            /* Subtle Glass Border */
            --glass-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .light-mode {
            /* Light Gradient + Subtle Warm Glow */
            --bg-primary: radial-gradient(circle at 50% 10%, rgba(59, 130, 246, 0.05) 0%, transparent 50%), linear-gradient(135deg, #e0e7ff 0%, #f3f4f6 100%);
            --bg-secondary: rgba(255, 255, 255, 0.6);
            --bg-panel: rgba(255, 255, 255, 0.7);
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-primary: rgba(0, 0, 0, 0.05);
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s;
            background-attachment: fixed;
            min-height: 100vh;
        }

        /* Glassmorphism Classes */
        .glass {
            background: var(--bg-panel);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border-primary);
            box-shadow: var(--glass-shadow);
        }

        .panel {
            background: var(--bg-panel);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            /* Softer corners */
            padding: 24px;
            transition: all 0.3s;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
        }

        .panel:hover {
            border-color: rgba(59, 130, 246, 0.3);
            transform: translateY(-2px);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            margin: 0 8px 4px;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #f1f5f9;
        }

        .nav-item.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            color: white;
            font-weight: 600;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .input-box {
            width: 100%;
            padding: 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            color: var(--text-primary);
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px -1px rgba(59, 130, 246, 0.6);
        }

        @keyframes pulse-slow {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.8;
                transform: scale(0.98);
            }
        }

        /* Auto-Flow Grid Background */
        .flow-grid {
            background-size: 40px 40px;
            background-image:
                linear-gradient(to right, rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
        }




        .animate-pulse-slow {
            animation: pulse-slow 8s infinite alternate;
        }
    </style>
    <!-- Failsafe Navigation Logic (Head Injection) -->
    <script>
        // Global Navigation Function (Failsafe)
        window.switchTab = function (tabId) {
            console.log('Switching to tab (Inline Head):', tabId);

            // 1. UI Switch
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            const target = document.getElementById(tabId);
            if (target) target.classList.add('active');

            // 🛑 FORCE FIX: Toggle Dashboard Extras
            const extra1 = document.getElementById('dashboard-extra-1');
            const extra2 = document.getElementById('dashboard-extra-2');
            if (tabId === 'dashboard') {
                if (extra1) extra1.style.display = 'block';
                if (extra2) extra2.style.display = 'block';
            } else {
                if (extra1) extra1.style.display = 'none';
                if (extra2) extra2.style.display = 'none';
            }

            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
            const navBtn = document.getElementById('nav-' + tabId);
            if (navBtn) navBtn.classList.add('active');

            // 2. Try to call app.js logic if loaded
            try {
                if (tabId === 'exhibition' && typeof renderExpos === 'function') renderExpos();
                if (tabId === 'dashboard' && typeof updateDashboard === 'function') updateDashboard();
                if (tabId === 'email-templates' && typeof renderTemplateList === 'function') renderTemplateList();
            } catch (e) {
                console.warn('App logic not fully loaded yet:', e);
            }
        };

        window.toggleTheme = function () {
            const body = document.body;
            const isLight = body.classList.contains('light-mode');
            if (isLight) {
                body.classList.remove('light-mode');
                const icon = document.getElementById('theme-icon');
                if (icon) icon.innerText = '🌙';
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.add('light-mode');
                const icon = document.getElementById('theme-icon');
                if (icon) icon.innerText = '☀️';
                localStorage.setItem('theme', 'light');
            }
        };

        // Expose to window explicitly
        window.showTab = window.switchTab;
    </script>
</head>

<body class="h-screen flex overflow-hidden">
    <!-- 🆕 Phase 18: Premium Auth Modal -->
    <div id="auth-modal"
        class="fixed inset-0 z-[9999] flex items-center justify-center bg-gradient-to-br from-slate-900 via-blue-900/20 to-black backdrop-blur-md">

        <!-- Animated Background Orbs -->
        <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-blue-500/20 rounded-full blur-3xl animate-pulse"></div>
        <div class="absolute bottom-1/4 right-1/4 w-96 h-96 bg-purple-500/20 rounded-full blur-3xl animate-pulse"
            style="animation-delay: 2s;"></div>

        <div
            class="bg-slate-900/60 backdrop-blur-2xl p-8 rounded-3xl border border-white/10 shadow-2xl w-full max-w-sm relative overflow-hidden z-10 transform transition-all duration-300 hover:scale-[1.01] hover:shadow-blue-500/20">

            <div class="text-center mb-8">
                <div
                    class="w-16 h-16 bg-gradient-to-tr from-blue-500 to-purple-600 rounded-2xl mx-auto flex items-center justify-center mb-4 shadow-lg shadow-blue-500/30">
                    <span class="text-3xl">🚀</span>
                </div>
                <h1 class="text-2xl font-bold text-white tracking-tight">Morgan OS</h1>
                <p class="text-xs text-blue-300/80 mt-2 tracking-widest uppercase" id="auth-subtitle">Enterprise Command
                    Center</p>
            </div>

            <div id="auth-form" class="space-y-4">
                <div class="relative group">
                    <div
                        class="absolute -inset-0.5 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl opacity-30 group-hover:opacity-100 transition duration-500 blur">
                    </div>
                    <input type="email" id="auth-email"
                        class="relative block w-full bg-slate-800/80 text-white placeholder-gray-500 border border-white/10 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-slate-800 transition-all font-medium"
                        placeholder="name@morgan.com">
                </div>

                <div class="relative group">
                    <div
                        class="absolute -inset-0.5 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl opacity-30 group-hover:opacity-100 transition duration-500 blur">
                    </div>
                    <input type="password" id="auth-password"
                        class="relative block w-full bg-slate-800/80 text-white placeholder-gray-500 border border-white/10 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-slate-800 transition-all font-medium"
                        placeholder="••••••••">
                </div>

                <div id="auth-error"
                    class="hidden p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400 text-xs text-center font-medium animate-shake">
                </div>

                <button onclick="handleAuthSubmit()" id="auth-submit-btn"
                    class="w-full py-3.5 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-bold rounded-xl shadow-lg shadow-blue-600/30 transition-all duration-300 transform active:scale-95 flex items-center justify-center gap-2 group">
                    <span>Login</span>
                    <span class="group-hover:translate-x-1 transition-transform">→</span>
                </button>

                <div class="flex items-center justify-between text-xs text-gray-400 mt-6 pt-4 border-t border-white/5">
                    <span id="auth-mode-text">Need an account?</span>
                    <button onclick="toggleAuthMode()" id="auth-toggle-btn"
                        class="text-blue-400 hover:text-blue-300 font-bold transition-colors">Create Account</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Main App Container (Hidden until Auth) -->
    <div id="app-main" class="flex h-screen overflow-hidden hidden">
        <!-- Sidebar -->
        <aside id="sidebar"
            class="w-64 flex flex-col h-full bg-slate-900/50 backdrop-blur-xl border-r border-white/5 relative z-20 transition-all duration-300 transform translate-x-0"
            style="border-color: var(--border-primary);">

            <div class="p-6 border-b" style="border-color: var(--border-primary);">
                <div class="flex items-center justify-between mb-2">
                    <h1 class="text-2xl font-black" style="color: var(--text-primary);"><span
                            class="text-blue-500">●</span>
                        Morgan.OS</h1>
                    <button onclick="toggleTheme()" class="p-2 rounded-lg hover:bg-gray-700 transition">
                        <span id="theme-icon">🌙</span>
                    </button>
                </div>
                <!-- User Info -->
                <div id="user-info-display" class="mt-4 p-3 bg-slate-800/50 rounded-lg border border-white/5">
                    <div class="text-xs text-gray-500">未登录</div>
                </div>

                <div class="mt-2 text-xs text-green-400 font-bold ml-1">v18.36 TOAST FIX</div>
            </div>

            <nav class="flex-1 p-3 overflow-y-auto">
                <div class="px-4 mb-2 mt-2 text-xs font-bold text-blue-400 uppercase">核心</div>
                <button onclick="switchTab('dashboard')" class="nav-item active"
                    id="nav-dashboard"><span>🏠</span><span>指挥舱</span></button>
                <div class="px-4 mb-2 mt-4 text-xs font-bold text-blue-400 uppercase">知识库</div>
                <button onclick="switchTab('product-db')" class="nav-item"
                    id="nav-product-db"><span>🗂️</span><span>公司Rag知识库</span></button>
                <button onclick="switchTab('keyword-vault')" class="nav-item"
                    id="nav-keyword-vault"><span>🔑</span><span>SEO词库</span></button>
                <div class="px-4 mb-2 mt-4 text-xs font-bold text-blue-400 uppercase">策划</div>
                <button onclick="switchTab('weekly-plan')" class="nav-item"
                    id="nav-weekly-plan"><span>📅</span><span>内容日历</span></button>
                <button onclick="switchTab('exhibition')" class="nav-item"
                    id="nav-exhibition"><span>🎪</span><span>展会作战</span></button>
                <div class="px-4 mb-2 mt-4 text-xs font-bold text-blue-400 uppercase">执行</div>
                <button onclick="switchTab('ad-doctor')" class="nav-item"
                    id="nav-ad-doctor"><span>🩺</span><span>广告诊断</span></button>
                <button onclick="switchTab('budget')" class="nav-item"
                    id="nav-budget"><span>📊</span><span>资金看板</span></button>
                <button onclick="switchTab('social-matrix')" class="nav-item"
                    id="nav-social-matrix"><span>🌍</span><span>社媒矩阵</span></button>
                <button onclick="switchTab('competitor-watch')" class="nav-item"
                    id="nav-competitor-watch"><span>⚔️</span><span>竞对情报局</span></button>
                <button onclick="switchTab('price-calculator')" class="nav-item"
                    id="nav-price-calculator"><span>💰</span><span>报价计算器</span></button>
                <div class="px-4 mb-2 mt-4 text-xs font-bold text-blue-400 uppercase">工具</div>
                <button onclick="switchTab('customer-deep-dive')" class="nav-item"
                    id="nav-deep-dive"><span>🕵️</span><span>客户背调
                        (KYC)</span></button>
                <button onclick="switchTab('rfq-decoder')" class="nav-item" id="nav-rfq"><span>🧩</span><span>询盘解码
                        (RFQ)</span></button>
                <button onclick="switchTab('email-templates')" class="nav-item"
                    id="nav-email-templates"><span>📧</span><span>邮件模板库</span></button>
                <div class="px-4 mb-2 mt-4 text-xs font-bold text-blue-400 uppercase">自动化</div>
                <button onclick="switchTab('automation')" class="nav-item" id="nav-automation"><span>⚡</span><span>工作流
                        (n8n)</span></button>
                <button onclick="switchTab('auto-flow')" class="nav-item" id="nav-auto-flow"><span>🌀</span><span>智能流程
                        (Auto-Flow)</span></button>
                <div class="px-4 mb-2 mt-4 text-xs font-bold text-blue-400 uppercase">AI 助手</div>
                <a href="seo_ai.html" target="_blank" class="nav-item"
                    style="display: flex; align-items: center; gap: 12px; text-decoration: none;">
                    <span>🤖</span><span>SEO AI</span>
                </a>
                <a href="ad_oracle.html" target="_blank" class="nav-item"
                    style="display: flex; align-items: center; gap: 12px; text-decoration: none;">
                    <span>🔮</span><span>广告预言家</span>
                </a>
            </nav>
            <div class="p-4 border-t text-center text-xs" style="border-color: var(--border-primary);">
                <button onclick="exportData()" class="hover:text-blue-400" style="color: var(--text-secondary);">☁️
                    备份</button>
                <span style="color: var(--text-secondary);"> | </span>
                <button onclick="document.getElementById('import-file').click()" class="hover:text-blue-400"
                    style="color: var(--text-secondary);">📥 恢复</button>
                <span style="color: var(--text-secondary);"> | </span>
                <button onclick="configureSettings()" class="hover:text-blue-400"
                    style="color: var(--text-secondary);">⚙️
                    设置</button>
                <span style="color: var(--text-secondary);"> | </span>
                <button onclick="handleLogout()" class="hover:text-red-400" style="color: var(--text-secondary);">🚪
                    退出</button>
                <input type="file" id="import-file" class="hidden" onchange="importData(this)">
            </div>
        </aside>

        <!-- Main -->
        <main class="flex-1 overflow-y-auto p-4 md:p-8 w-full relative">
            <!-- Mobile Header -->
            <div class="md:hidden flex items-center justify-between mb-6">
                <button onclick="toggleSidebar()" class="text-2xl p-2 rounded hover:bg-white/5">
                    ☰
                </button>
                <h1 class="text-lg font-black text-gray-200">TDS.OS Mobile</h1>
                <div class="w-8"></div> <!-- Spacer -->
            </div>

            <div class="max-w-7xl mx-auto">
                <!-- Dashboard -->
                <div id="dashboard" class="tab-content active">
                    <h2 class="text-4xl font-black mb-2" style="color: var(--text-primary);">战略指挥舱</h2>
                    <p class="text-sm mb-8" style="color: var(--text-secondary);">Overview · 一键直达作战前线</p>
                    <!-- Morning Briefing Card -->
                    <div class="panel mb-6 border-l-4 border-purple-500 relative overflow-hidden group">
                        <div
                            class="absolute right-0 top-0 opacity-10 text-9xl transform translate-x-10 -translate-y-10">
                            ☕
                        </div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-600 mb-1"
                                        id="briefing-title">Good Morning, Director.</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">AI 战略参谋已就绪</p>
                                </div>
                                <button onclick="generateBriefing()"
                                    class="px-3 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-500 transition shadow-lg shadow-purple-900/50 flex items-center gap-1 font-semibold">
                                    🤖 生成今日简报
                                </button>
                            </div>
                            <div class="prose prose-invert max-w-none">
                                <p id="briefing-content"
                                    class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed animate-pulse">
                                    点击按钮，获取基于全站数据的今日战略建议...
                                </p>
                            </div>
                        </div>

                        <!-- Row 1: Key Metrics (Charts) -->
                        <!-- Row 1: Key Metrics (Charts) - Optimized UI -->
                        <div class="grid grid-cols-3 gap-6 mb-6">
                            <!-- Budget Chart -->
                            <div class="panel relative group cursor-pointer hover:border-green-500/50 transition-all"
                                onclick="switchTab('budget')">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <h3 class="text-gray-400 text-xs font-bold uppercase tracking-wider">资金消耗 (Burn
                                            Rate)
                                        </h3>
                                        <div id="dash-budget-detail" class="text-[10px] text-gray-500 mt-1">Details >
                                        </div>
                                    </div>
                                    <span id="dash-budget"
                                        class="text-green-400 font-mono font-black text-4xl">¥--</span>
                                </div>
                                <div class="h-32 w-full relative">
                                    <canvas id="budgetChart"></canvas>
                                </div>
                                <div
                                    class="absolute top-4 right-4 text-green-500 opacity-0 group-hover:opacity-100 transition-opacity">
                                    ↗</div>
                            </div>

                            <!-- CPL Chart -->
                            <div class="panel relative group cursor-pointer hover:border-blue-500/50 transition-all"
                                onclick="switchTab('ad-doctor')">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <h3 class="text-gray-400 text-xs font-bold uppercase tracking-wider">CPL 走势 (7
                                            Days)
                                        </h3>
                                        <div id="dash-cpl-status" class="text-[10px] text-gray-500 mt-1">Details ></div>
                                    </div>
                                    <span id="dash-cpl" class="text-blue-400 font-mono font-black text-4xl">$--</span>
                                </div>
                                <div class="h-32 w-full relative">
                                    <canvas id="cplChart"></canvas>
                                </div>
                                <div
                                    class="absolute top-4 right-4 text-blue-500 opacity-0 group-hover:opacity-100 transition-opacity">
                                    ↗</div>
                            </div>

                            <!-- Next Expo -->
                            <div class="panel relative overflow-hidden group cursor-pointer hover:border-purple-500/50 transition-all"
                                onclick="switchTab('exhibition')">
                                <div
                                    class="absolute -right-6 -top-6 w-24 h-24 bg-purple-500/20 rounded-full blur-xl group-hover:bg-purple-500/30 transition-all">
                                </div>
                                <h3 class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-2">近期作战 (Next
                                    Expo)
                                </h3>
                                <div class="flex flex-col h-full justify-between pb-4">
                                    <div class="text-2xl font-black text-white/90 mb-1 truncate" id="dash-expo-name">
                                        Checking...
                                    </div>
                                    <div class="flex items-baseline justify-between mt-2">
                                        <div class="text-xs text-gray-400">距离开展仅剩</div>
                                        <div>
                                            <span class="text-5xl font-black text-white" id="dash-expo-days">0</span>
                                            <span class="text-sm font-bold text-gray-500 uppercase">Days</span>
                                        </div>
                                    </div>
                                </div>
                                <div
                                    class="absolute top-4 right-4 text-purple-500 opacity-0 group-hover:opacity-100 transition-opacity">
                                    ↗</div>
                            </div>
                        </div>

                        <!-- Global Market Radar -->
                        <div class="panel mb-6 relative overflow-hidden">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-lg" style="color: var(--text-primary);">🌐 全球战区雷达 (Global
                                    Market
                                    Radar)</h3>
                                <div class="text-xs text-blue-400 font-mono" id="radar-utc">UTC --:--</div>
                            </div>
                            <div class="grid grid-cols-4 gap-4" id="radar-grid">
                                <!-- North America -->
                                <div
                                    class="relative group overflow-hidden rounded-2xl p-5 bg-gradient-to-br from-slate-800/80 to-slate-900/80 border border-slate-700/50 hover:border-blue-500/50 transition-all duration-500 shadow-xl">
                                    <div
                                        class="absolute top-0 right-0 w-20 h-20 bg-blue-500/10 rounded-full blur-2xl -mr-10 -mt-10 transition group-hover:bg-blue-500/20">
                                    </div>
                                    <div class="flex justify-between items-start mb-3">
                                        <div class="flex flex-col">
                                            <span
                                                class="text-[10px] font-bold tracking-widest text-blue-400 uppercase">North
                                                America</span>
                                            <span class="text-[10px] text-gray-500">New York (EST)</span>
                                        </div>
                                        <div id="status-dot-ny"
                                            class="w-2 h-2 rounded-full bg-gray-600 shadow-[0_0_8px_rgba(0,0,0,0.5)]">
                                        </div>
                                    </div>
                                    <div class="flex items-baseline gap-2">
                                        <div class="text-4xl font-light tracking-tight text-white font-mono"
                                            id="time-ny">
                                            --:--</div>
                                        <div class="text-xs text-gray-500 font-medium" id="ampm-ny">--</div>
                                    </div>
                                    <div class="mt-3 flex items-center gap-2">
                                        <div class="h-1 flex-1 bg-gray-800 rounded-full overflow-hidden">
                                            <div id="progress-ny"
                                                class="h-full bg-gray-600 w-0 transition-all duration-1000"></div>
                                        </div>
                                        <span class="text-[10px] font-mono text-gray-500 uppercase"
                                            id="action-ny">Loading...</span>
                                    </div>
                                </div>

                                <!-- Europe -->
                                <div
                                    class="relative group overflow-hidden rounded-2xl p-5 bg-gradient-to-br from-slate-800/80 to-slate-900/80 border border-slate-700/50 hover:border-indigo-500/50 transition-all duration-500 shadow-xl">
                                    <div
                                        class="absolute top-0 right-0 w-20 h-20 bg-indigo-500/10 rounded-full blur-2xl -mr-10 -mt-10 transition group-hover:bg-indigo-500/20">
                                    </div>
                                    <div class="flex justify-between items-start mb-3">
                                        <div class="flex flex-col">
                                            <span
                                                class="text-[10px] font-bold tracking-widest text-indigo-400 uppercase">Europe</span>
                                            <span class="text-[10px] text-gray-500">London (GMT)</span>
                                        </div>
                                        <div id="status-dot-ldn" class="w-2 h-2 rounded-full bg-gray-600"></div>
                                    </div>
                                    <div class="flex items-baseline gap-2">
                                        <div class="text-4xl font-light tracking-tight text-white font-mono"
                                            id="time-ldn">
                                            --:--</div>
                                        <div class="text-xs text-gray-500 font-medium" id="ampm-ldn">--</div>
                                    </div>
                                    <div class="mt-3 flex items-center gap-2">
                                        <div class="h-1 flex-1 bg-gray-800 rounded-full overflow-hidden">
                                            <div id="progress-ldn"
                                                class="h-full bg-gray-600 w-0 transition-all duration-1000"></div>
                                        </div>
                                        <span class="text-[10px] font-mono text-gray-500 uppercase"
                                            id="action-ldn">Loading...</span>
                                    </div>
                                </div>

                                <!-- Middle East -->
                                <div
                                    class="relative group overflow-hidden rounded-2xl p-5 bg-gradient-to-br from-slate-800/80 to-slate-900/80 border border-slate-700/50 hover:border-yellow-500/50 transition-all duration-500 shadow-xl">
                                    <div
                                        class="absolute top-0 right-0 w-20 h-20 bg-yellow-500/10 rounded-full blur-2xl -mr-10 -mt-10 transition group-hover:bg-yellow-500/20">
                                    </div>
                                    <div class="flex justify-between items-start mb-3">
                                        <div class="flex flex-col">
                                            <span
                                                class="text-[10px] font-bold tracking-widest text-yellow-400 uppercase">Middle
                                                East</span>
                                            <span class="text-[10px] text-gray-500">Dubai (GST)</span>
                                        </div>
                                        <div id="status-dot-dxb" class="w-2 h-2 rounded-full bg-gray-600"></div>
                                    </div>
                                    <div class="flex items-baseline gap-2">
                                        <div class="text-4xl font-light tracking-tight text-white font-mono"
                                            id="time-dxb">
                                            --:--</div>
                                        <div class="text-xs text-gray-500 font-medium" id="ampm-dxb">--</div>
                                    </div>
                                    <div class="mt-3 flex items-center gap-2">
                                        <div class="h-1 flex-1 bg-gray-800 rounded-full overflow-hidden">
                                            <div id="progress-dxb"
                                                class="h-full bg-gray-600 w-0 transition-all duration-1000"></div>
                                        </div>
                                        <span class="text-[10px] font-mono text-gray-500 uppercase"
                                            id="action-dxb">Loading...</span>
                                    </div>
                                </div>

                                <!-- APAC -->
                                <div
                                    class="relative group overflow-hidden rounded-2xl p-5 bg-gradient-to-br from-slate-800/80 to-slate-900/80 border border-slate-700/50 hover:border-red-500/50 transition-all duration-500 shadow-xl">
                                    <div
                                        class="absolute top-0 right-0 w-20 h-20 bg-red-500/10 rounded-full blur-2xl -mr-10 -mt-10 transition group-hover:bg-red-500/20">
                                    </div>
                                    <div class="flex justify-between items-start mb-3">
                                        <div class="flex flex-col">
                                            <span
                                                class="text-[10px] font-bold tracking-widest text-red-400 uppercase">APAC</span>
                                            <span class="text-[10px] text-gray-500">Beijing (CST)</span>
                                        </div>
                                        <div id="status-dot-bj" class="w-2 h-2 rounded-full bg-gray-600"></div>
                                    </div>
                                    <div class="flex items-baseline gap-2">
                                        <div class="text-4xl font-light tracking-tight text-white font-mono"
                                            id="time-bj">
                                            --:--</div>
                                        <div class="text-xs text-gray-500 font-medium" id="ampm-bj">--</div>
                                    </div>
                                    <div class="mt-3 flex items-center gap-2">
                                        <div class="h-1 flex-1 bg-gray-800 rounded-full overflow-hidden">
                                            <div id="progress-bj"
                                                class="h-full bg-gray-600 w-0 transition-all duration-1000"></div>
                                        </div>
                                        <span class="text-[10px] font-mono text-gray-500 uppercase"
                                            id="action-bj">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 🆕 Phase 15: Inquiry Trend Chart -->
                        <div id="dashboard-extra-1" class="col-span-12 lg:col-span-6 panel">
                            <h3 class="font-bold mb-4 flex items-center gap-2 text-gray-200">
                                <span>📊</span> 询盘趋势 (Inquiry Trend)
                            </h3>
                            <div style="position: relative; height: 200px;">
                                <canvas id="inquiry-trend-chart"></canvas>
                            </div>

                            <!-- Quick Insights -->
                            <div class="grid grid-cols-3 gap-2 mt-4 text-xs">
                                <div class="text-center p-2 rounded bg-blue-900/20">
                                    <div class="text-gray-500 mb-1">本周</div>
                                    <div class="text-2xl font-bold text-blue-400" id="week-count">0</div>
                                </div>
                                <div class="text-center p-2 rounded bg-purple-900/20">
                                    <div class="text-gray-500 mb-1">环比</div>
                                    <div class="text-lg font-bold" id="week-change">--</div>
                                </div>
                                <div class="text-center p-2 rounded bg-green-900/20">
                                    <div class="text-gray-500 mb-1">高价值占比</div>
                                    <div class="text-lg font-bold text-green-400" id="high-value-ratio">0%</div>
                                </div>
                            </div>
                        </div>

                        <!-- 🆕 Phase 16: Today's Follow-ups -->
                        <div id="dashboard-extra-2" class="col-span-12 lg:col-span-4 panel">
                            <h3 class="font-bold mb-4 flex items-center gap-2 text-gray-200">
                                <span>⏰</span> 今日跟进 (Today's Follow-ups)
                            </h3>
                            <div id="followup-list" class="space-y-2 max-h-48 overflow-y-auto">
                                <div class="text-gray-500 text-sm text-center py-4">暂无跟进任务</div>
                            </div>
                            <div class="mt-4 pt-4 border-t border-gray-700 flex gap-2">
                                <button onclick="showAddFollowupModal()"
                                    class="flex-1 px-3 py-2 bg-blue-600 hover:bg-blue-500 text-white text-sm font-bold rounded-lg transition">
                                    + 添加任务
                                </button>
                                <button onclick="showAllFollowups()"
                                    class="px-3 py-2 bg-gray-700 hover:bg-gray-600 text-gray-300 text-sm rounded-lg transition">
                                    查看全部
                                </button>
                            </div>
                        </div>

                    </div>

                    <!-- End of Dashboard -->
                </div>

                <!-- Product DB - Smart Knowledge Base -->
                <div id="product-db" class="tab-content">
                    <div class="flex justify-between items-end mb-4">
                        <div>
                            <h2 class="text-3xl font-black mb-2" style="color: var(--text-primary);">AI 知识大脑 (Knowledge
                                Base)</h2>
                            <p class="text-sm" style="color: var(--text-secondary);">Local RAG System · 您的业务随身专家 (Data
                                Stays
                                Local)</p>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-500 uppercase">Knowledge Status</div>
                            <div class="text-xl font-bold text-green-400 font-mono"><span id="kb-count">0</span> Chunks
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-12 gap-6 h-[600px]">
                        <!-- Left: Ingest & Source -->
                        <div class="col-span-4 flex flex-col gap-4">
                            <!-- Ingest Panel -->
                            <div class="space-y-2">
                                <div class="panel border-dashed border-2 border-gray-700 hover:border-blue-500 transition-colors cursor-pointer relative group p-4"
                                    onclick="document.getElementById('kb-upload').click()">
                                    <input type="file" id="kb-upload" class="hidden" accept=".txt,.md,.csv,.json,.pdf"
                                        multiple onchange="ingestKnowledge(this)">
                                    <div class="text-center">
                                        <div class="text-3xl mb-1 group-hover:scale-110 transition-transform">📂</div>
                                        <h3 class="font-bold text-white text-sm">上传文件 (Upload)</h3>
                                        <p class="text-[10px] text-gray-500">PDF / TXT / MD / CSV</p>
                                    </div>
                                    <!-- Uploading Overlay -->
                                    <div id="kb-ingesting"
                                        class="hidden absolute inset-0 bg-black/80 flex flex-col items-center justify-center rounded">
                                        <div class="animate-spin text-xl mb-1">⚡</div>
                                        <div class="text-[10px] text-blue-400 font-mono">Processing...</div>
                                    </div>
                                </div>

                                <button onclick="document.getElementById('paste-modal').classList.remove('hidden')"
                                    class="w-full py-3 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded text-xs text-gray-300 transition-colors flex items-center justify-center gap-2">
                                    <span>📋</span> 粘贴文本 (Paste Content)
                                </button>
                            </div>

                            <!-- Manage Panel -->
                            <div class="panel flex-1 flex flex-col overflow-hidden">
                                <div class="flex justify-between items-center mb-2 pb-2 border-b border-gray-700">
                                    <h3 class="font-bold text-sm text-gray-400">已加载文档</h3>
                                    <button onclick="clearKnowledge()"
                                        class="text-xs text-red-500 hover:text-red-400">清空</button>
                                </div>
                                <div id="kb-file-list"
                                    class="flex-1 overflow-y-auto space-y-2 text-xs font-mono text-gray-500">
                                    <div class="italic text-center py-4">暂无知识库文件</div>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Chat Interface -->
                        <div class="col-span-8 flex flex-col panel relative">
                            <!-- Chat History -->
                            <canvas id="rag-graph" class="absolute inset-0 pointer-events-none opacity-20"></canvas>
                            <!-- Knowledge Neural Net -->
                            <div id="kb-chat-history" class="flex-1 overflow-y-auto p-4 space-y-6 relative z-10">
                                <!-- Welcome -->
                                <div class="flex gap-4">
                                    <div
                                        class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-xs">
                                        AI</div>
                                    <div class="flex-1 space-y-2">
                                        <div
                                            class="bg-gray-800 p-3 rounded-lg rounded-tl-none inline-block text-sm text-gray-300">
                                            你好！我是您的专属业务专家。请先在左侧上传产品手册或 FAQ，然后问我任何问题。
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Context Inspector (Collapsible) -->
                            <div id="kb-context-inspector"
                                class="hidden border-t border-gray-700 bg-gray-900/50 p-2 text-xs font-mono text-gray-500 h-32 overflow-y-auto">
                                <div class="font-bold text-blue-400 mb-1">🔍 引用来源 (Reference Context):</div>
                                <div id="kb-context-content" class="space-y-2"></div>
                            </div>

                            <!-- Verify Status (Float) -->
                            <div id="kb-ai-working"
                                class="hidden absolute bottom-20 left-12 flex items-center gap-2 bg-black/60 px-3 py-1 rounded-full border border-blue-500/30">
                                <span class="animate-ping w-2 h-2 rounded-full bg-blue-400"></span>
                                <span class="text-xs text-blue-300 font-mono">Searching Knowledge Base...</span>
                            </div>

                            <!-- Input Area -->
                            <div class="mt-4 border-t border-gray-700 pt-4">
                                <div class="relative">
                                    <input type="text" id="kb-query"
                                        class="w-full bg-gray-900 border border-gray-700 rounded-lg pl-4 pr-12 py-3 focus:border-blue-500 outline-none text-white text-sm"
                                        placeholder="问点什么... (Ask about MOQ, Specs, Price...)"
                                        onkeypress="if(event.key==='Enter') askKnowledgeBase()">
                                    <button onclick="askKnowledgeBase()"
                                        class="absolute right-2 top-2 p-1.5 bg-blue-600 rounded hover:bg-blue-500 transition-colors">
                                        ⬆️
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Weekly Plan -->
                <div id="weekly-plan" class="tab-content">
                    <h2 class="text-3xl font-black mb-8" style="color: var(--text-primary);">内容日历</h2>
                    <div class="grid grid-cols-12 gap-6">

                        <div class="col-span-12 space-y-4">
                            <!-- Calendar Controls -->
                            <div
                                class="flex flex-col md:flex-row justify-between items-center mb-6 bg-slate-800/40 p-4 rounded-xl border border-gray-700/50 backdrop-blur-sm">
                                <div class="flex flex-col gap-1 mb-3 md:mb-0">
                                    <h3 class="font-bold text-xl text-white flex items-center gap-2">
                                        <span class="bg-blue-600 text-white p-1 rounded">📅</span>
                                        本周内容规划 (Weekly Plan)
                                    </h3>
                                    <div class="flex items-center gap-2 text-xs text-gray-400">
                                        <span class="w-2 h-2 rounded-full bg-green-500"></span>
                                        <span>Strategy V21 Online</span>
                                    </div>
                                </div>

                                <div
                                    class="flex gap-3 items-center bg-gray-900/50 p-1.5 rounded-lg border border-gray-700">
                                    <div class="flex flex-col">
                                        <label class="text-[10px] text-gray-500 uppercase font-bold px-1">当前阶段
                                            (Phase)</label>
                                        <select id="calendar-strategy"
                                            class="bg-transparent text-sm text-blue-400 font-bold outline-none cursor-pointer hover:text-blue-300 transition-colors">
                                            <option value="Aggressive">🔥 激进拓客 (Aggressive)</option>
                                            <option value="Value">💎 价值验证 (Value Proof)</option>
                                            <option value="Educational">🎓 技术教育 (Educational)</option>
                                        </select>
                                    </div>
                                    <div class="h-8 w-px bg-gray-700 mx-1"></div>
                                    <button onclick="generateWeeklyPlan()"
                                        class="btn-primary py-2 px-5 text-sm font-bold shadow-lg shadow-blue-600/20 hover:shadow-blue-600/40 border border-blue-500/50"
                                        style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
                                        ✨ 立即生成
                                    </button>
                                </div>
                            </div>

                            <!-- 7-Day Grid -->
                            <div id="calendar-grid" class="grid grid-cols-7 gap-4 overflow-x-auto pb-4 px-1">
                                <!-- Dynamic Days (Empty State) -->
                                <div
                                    class="col-span-7 flex flex-col items-center justify-center p-12 bg-white dark:bg-gray-800/50 border border-dashed border-gray-300 dark:border-gray-700 rounded-2xl shadow-sm">
                                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-full mb-4">
                                        <div class="text-3xl">📅</div>
                                    </div>
                                    <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100 mb-2">准备好规划的一周了吗？</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-6 text-center max-w-md">
                                        AI 将读取您的《TDS2026 战略 V21》，为您量身定制 7 天的全渠道内容矩阵。<br>
                                        (AI will generate a 7-day plan based on your Strategy V21)
                                    </p>
                                    <button onclick="generateWeeklyPlan()"
                                        class="btn-primary py-2 px-6 shadow-lg shadow-blue-500/30 hover:shadow-blue-500/50 transition-all transform hover:-translate-y-0.5"
                                        style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                                        🚀 立即生成周计划 (Generate Plan)
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Keyword Vault -->
                <div id="keyword-vault" class="tab-content">
                    <h2 class="text-3xl font-black mb-8" style="color: var(--text-primary);">SEO 关键词金库</h2>
                    <div class="grid grid-cols-2 gap-6">
                        <div class="panel">
                            <textarea id="vault-input" class="input-box font-mono text-xs" rows="15"
                                placeholder="每行一个关键词..."></textarea>
                            <button onclick="saveKeywords()" class="btn-primary w-full mt-4">💾 存入</button>
                        </div>
                        <div class="panel">
                            <h3 class="font-bold mb-4" style="color: var(--text-primary);">已存 <span
                                    id="kw-count">0</span> 词
                            </h3>
                            <div id="vault-display" class="p-4 rounded h-64 overflow-auto mb-4 font-mono text-xs"
                                style="background: var(--bg-secondary); color: var(--text-secondary);">暂无数据</div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="flex gap-2">
                                    <button onclick="formatKeywords('exact')" class="btn-primary">[精准]</button>
                                    <button onclick="formatKeywords('phrase')" class="btn-primary">"词组"</button>
                                    <button onclick="expandKeywords()" class="btn-primary"
                                        style="background: linear-gradient(90deg, #f59e0b, #d97706);">⚡ 智能裂变</button>
                                    <button onclick="analyzeKeywordIntent()" class="btn-primary"
                                        style="background: linear-gradient(90deg, #10b981, #059669);">🧠 意图透视</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>



                <!-- Competitor Scout -->
                <div id="competitor-scout" class="tab-content">
                    <h2 class="text-3xl font-black mb-2" style="color: var(--text-primary);">竞对透视镜 (Competitor Scout)
                    </h2>
                    <p class="text-sm mb-8" style="color: var(--text-secondary);">Battle Card Generator · 知己知彼 百战不殆</p>

                    <div class="grid grid-cols-12 gap-6">
                        <!-- Left: Input -->
                        <div class="col-span-4">
                            <div class="panel h-full border-l-4 border-red-600">
                                <h3 class="font-bold mb-6 flex items-center gap-2 text-red-500">
                                    <span>🎯</span> 锁定目标
                                </h3>

                                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">对手名称
                                    (Competitor)</label>
                                <input type="text" id="scout-name" class="input-box mb-4"
                                    placeholder="例如：CompetitorX Co., Ltd.">

                                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">情报收集 (Intel)</label>
                                <textarea id="scout-info"
                                    class="input-box h-64 font-mono text-sm leading-relaxed mb-6 resize-none"
                                    placeholder="在此粘贴对手信息：
- 网址 URL
- 他的核心卖点
- 客户对他的评价/吐槽
- 他们的报价水平..."></textarea>

                                <button onclick="analyzeCompetitor()"
                                    class="btn-primary w-full py-4 text-lg shadow-lg shadow-red-900/50"
                                    style="background: linear-gradient(135deg, #dc2626, #991b1b);">
                                    ⚔️ 生成作战卡 (Generate)
                                </button>
                            </div>
                        </div>

                        <!-- Right: Battle Card -->
                        <div class="col-span-8">
                            <div id="scout-result-panel"
                                class="panel h-full relative overflow-hidden bg-gradient-to-br from-slate-900 to-red-900/20">
                                <!-- Placeholder -->
                                <div id="scout-placeholder"
                                    class="absolute inset-0 flex flex-col items-center justify-center text-gray-600 opacity-50">
                                    <div class="text-7xl mb-4">🛡️</div>
                                    <div class="text-sm">输入对手信息，生成攻防话术</div>
                                </div>

                                <!-- Loading -->
                                <div id="scout-loading"
                                    class="hidden absolute inset-0 flex flex-col items-center justify-center bg-gray-900/95 z-10">
                                    <div class="text-5xl animate-spin mb-6">⚔️</div>
                                    <div class="text-red-500 font-bold animate-pulse text-lg">正在分析敌方弱点...</div>
                                    <div class="text-xs text-gray-500 mt-2">SWOT Analysis • Value Prop Extraction • Kill
                                        Point Generation</div>
                                </div>

                                <!-- Result -->
                                <div id="scout-content" class="hidden h-full flex flex-col p-2">
                                    <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                                        <h3 class="text-2xl font-black text-white italic">BATTLE CARD</h3>
                                        <div
                                            class="px-3 py-1 bg-red-600 text-white text-xs font-bold rounded uppercase">
                                            VS
                                            <span id="scout-target-name">---</span>
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-2 gap-6 h-full overflow-y-auto">
                                        <!-- Weaknesses -->
                                        <div class="p-4 bg-red-900/20 rounded border border-red-500/30">
                                            <h4 class="text-red-400 font-bold mb-3 flex items-center gap-2">
                                                📉 敌方弱点 (Weaknesses)
                                            </h4>
                                            <ul id="scout-weakness-list"
                                                class="space-y-2 text-sm text-gray-300 list-disc pl-4">
                                            </ul>
                                        </div>

                                        <!-- Strengths (To Avoid) -->
                                        <div class="p-4 bg-gray-800/50 rounded border border-gray-600/30">
                                            <h4 class="text-gray-400 font-bold mb-3 flex items-center gap-2">
                                                🛡️ 敌方强项 (Avoid Head-on)
                                            </h4>
                                            <ul id="scout-strength-list"
                                                class="space-y-2 text-sm text-gray-400 list-disc pl-4">
                                            </ul>
                                        </div>

                                        <!-- Kill Scripts -->
                                        <div class="col-span-2 mt-4">
                                            <h4 class="text-yellow-400 font-bold mb-3 flex items-center gap-2 text-lg">
                                                🚀 必杀话术 (Kill Scripts)
                                            </h4>
                                            <div id="scout-scripts" class="space-y-4">
                                                <!-- Dynamic Scripts -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RFQ Decoder -->
                <div id="rfq-decoder" class="tab-content relative h-full">
                    <div class="h-full flex flex-col">
                        <div class="mb-8">
                            <h2 class="text-3xl font-black mb-2 flex items-center gap-3"
                                style="color: var(--text-primary);">
                                <span class="text-blue-500">📧</span> 询盘解码器 (RFQ Decoder)
                            </h2>
                            <p class="text-sm" style="color: var(--text-secondary);">First Principles Analysis ·
                                第一性原理意向识别
                            </p>
                        </div>

                        <div class="flex-1 grid grid-cols-12 gap-8 min-h-0">
                            <!-- Left: Input Area -->
                            <div class="col-span-12 lg:col-span-5 flex flex-col gap-4">
                                <div
                                    class="panel flex-1 flex flex-col bg-slate-800/80 backdrop-blur border border-slate-700">
                                    <label class="font-bold mb-3 flex items-center justify-between text-gray-300">
                                        <span>📜 原始邮件内容</span>
                                        <span class="text-xs font-normal text-gray-500">支持多语言自动检测</span>
                                    </label>

                                    <textarea id="rfq-input"
                                        class="flex-1 w-full bg-black/20 border border-gray-600 rounded-lg p-4 font-mono text-sm leading-relaxed text-gray-300 resize-none focus:border-blue-500 focus:outline-none transition"
                                        placeholder="请粘贴客户的完整邮件内容 (含签名档效果更好)..."></textarea>

                                    <div class="mt-4">
                                        <label class="block text-xs font-bold text-blue-400 uppercase mb-2">补充背景
                                            (Context)</label>
                                        <input type="text" id="rfq-context"
                                            class="input-box bg-black/20 border-gray-600"
                                            placeholder="例如：来自官网表单、德国客户、老客户推荐...">
                                    </div>

                                    <button onclick="analyzeRFQ()"
                                        class="mt-6 btn-primary w-full py-4 text-base font-bold shadow-lg shadow-blue-900/50 flex items-center justify-center gap-2 group">
                                        <span>🔍</span>
                                        <span class="group-hover:tracking-widest transition-all">深度解码 (Analyze)</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Right: Analysis Result -->
                            <div class="col-span-12 lg:col-span-7 h-full overflow-hidden">
                                <div id="rfq-result-panel"
                                    class="panel h-full relative overflow-hidden bg-slate-800/80 backdrop-blur border border-slate-700 flex flex-col">
                                    <!-- Placeholder State -->
                                    <div id="rfq-placeholder"
                                        class="absolute inset-0 flex flex-col items-center justify-center text-gray-500 opacity-40 select-none">
                                        <div class="text-8xl mb-6 grayscale text-blue-900">🕵️‍♂️</div>
                                        <div class="text-lg font-medium text-gray-400">等待输入询盘内容...</div>
                                        <p class="text-xs mt-2">AI 将从 情感、意图、背景 三个维度进行分析</p>
                                    </div>

                                    <!-- Loading State -->
                                    <div id="rfq-loading"
                                        class="hidden absolute inset-0 flex flex-col items-center justify-center bg-slate-900/90 z-20 backdrop-blur-sm">
                                        <div class="relative w-24 h-24 mb-6">
                                            <div
                                                class="absolute inset-0 border-4 border-blue-500/30 rounded-full animate-ping">
                                            </div>
                                            <div
                                                class="absolute inset-0 border-4 border-t-blue-500 rounded-full animate-spin">
                                            </div>
                                        </div>
                                        <div class="text-blue-400 font-bold animate-pulse text-lg">正在运用第一性原理分析...</div>
                                        <div class="flex gap-4 mt-4 text-xs text-gray-500 font-mono">
                                            <span>[Sentiment Analysis]</span>
                                            <span>[Intent Verification]</span>
                                        </div>
                                    </div>

                                    <!-- Result State -->
                                    <div id="rfq-content" class="hidden flex-1 flex flex-col h-full overflow-hidden">
                                        <!-- Insight Header -->
                                        <div
                                            class="flex items-center justify-between mb-6 pb-6 border-b border-gray-700/50">
                                            <div class="flex items-center gap-6">
                                                <div class="relative">
                                                    <div id="rfq-score-circle"
                                                        class="w-20 h-20 rounded-full border-[6px] border-blue-500/30 flex items-center justify-center text-3xl font-black text-white bg-slate-900 shadow-xl">
                                                        --
                                                    </div>
                                                    <div
                                                        class="absolute -bottom-2 -right-2 bg-blue-600 text-xs px-2 py-1 rounded text-white font-bold">
                                                        SCORE</div>
                                                </div>
                                                <div>
                                                    <div class="text-xs text-gray-400 uppercase tracking-wider mb-1">
                                                        Lead
                                                        Quality</div>
                                                    <div class="text-3xl font-bold text-white tracking-tight">成交潜力</div>
                                                </div>
                                            </div>
                                            <div id="rfq-intent-tag"
                                                class="px-5 py-2 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-300 text-sm font-bold shadow-lg">
                                                Unknown Intent
                                            </div>
                                        </div>

                                        <!-- Scrollable Content -->
                                        <div class="flex-1 overflow-y-auto pr-2 space-y-6">
                                            <!-- Analysis Report -->
                                            <div class="bg-black/20 rounded-xl p-5 border border-gray-700/50">
                                                <h4
                                                    class="text-blue-400 text-xs font-bold uppercase mb-3 flex items-center gap-2">
                                                    <span>📋</span> 侦探报告 (Detective Report)
                                                </h4>
                                                <ul id="rfq-analysis-list"
                                                    class="space-y-3 text-sm text-gray-300 leading-relaxed">
                                                    <!-- Dynamic items -->
                                                </ul>
                                            </div>

                                            <!-- Strategy (Highlight) -->
                                            <div
                                                class="relative overflow-hidden rounded-xl p-1 bg-gradient-to-r from-purple-500/20 to-pink-500/20">
                                                <div class="bg-slate-900/90 p-4 rounded-lg h-full">
                                                    <h4
                                                        class="text-purple-400 text-xs font-bold uppercase mb-2 flex items-center gap-2">
                                                        <span>💡</span> 建议回复策略 (Strategy)
                                                    </h4>
                                                    <div id="rfq-reply-strategy"
                                                        class="font-mono text-sm leading-relaxed text-gray-200">
                                                        <!-- Dynamic Strategy -->
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Action Area -->
                                            <div id="rfq-action-area" class="pt-4 hidden">
                                                <div class="flex items-center justify-between mb-3">
                                                    <h4
                                                        class="text-green-400 text-xs font-bold uppercase flex items-center gap-2">
                                                        <span>⚡</span> 智能回复草稿 (AI Draft)
                                                    </h4>
                                                    <button onclick="copyReply()"
                                                        class="text-xs text-gray-400 hover:text-white transition">
                                                        复制内容
                                                    </button>
                                                </div>
                                                <textarea id="rfq-reply-draft"
                                                    class="w-full h-32 bg-black/20 border border-gray-700 rounded-lg p-3 text-sm text-gray-300 font-mono mb-3 focus:border-green-500 focus:outline-none resize-none"
                                                    placeholder="点击下方生成按钮..."></textarea>

                                                <button onclick="generateRFQReply()"
                                                    class="w-full btn-primary py-3 bg-gradient-to-r from-green-600 to-emerald-600 border-none shadow-lg shadow-green-900/50 font-bold flex items-center justify-center gap-2 hover:scale-[1.02] transition-transform">
                                                    ✨ 生成高转化回复 (Generate Reply)
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Auto-Flow (Workflow Generator) -->
                <div id="auto-flow"
                    class="tab-content hidden flex-1 w-full flex flex-col relative overflow-hidden bg-[#0f172a]">
                    <!-- Top Bar -->
                    <div
                        class="absolute top-4 left-1/2 -translate-x-1/2 z-20 bg-[#1e293b]/90 backdrop-blur border border-gray-700 rounded-full px-6 py-2 flex items-center gap-6 shadow-2xl">
                        <div class="flex items-center gap-2 text-gray-200">
                            <span class="text-gray-400">📝</span>
                            <span class="font-bold text-sm">User Input</span>
                        </div>
                        <div class="w-px h-4 bg-gray-600"></div>
                        <div class="flex items-center gap-2 text-gray-400">
                            <span class="font-bold text-sm">Generate</span>
                        </div>
                        <div class="w-px h-4 bg-gray-600"></div>
                        <div class="flex items-center gap-2 text-gray-400">
                            <span class="font-bold text-sm">Output</span>
                        </div>
                        <div class="w-px h-4 bg-gray-600"></div>
                        <button onclick="FlowEngine.runSimulation()"
                            class="text-xs bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded-full font-bold transition">
                            ▶ Run Mock
                        </button>
                    </div>

                    <!-- Floating Input -->
                    <div class="absolute top-20 left-10 z-20 w-[350px]">
                        <div
                            class="panel bg-[#1e293b]/90 backdrop-blur border border-yellow-500/30 p-4 shadow-2xl relative">
                            <div class="absolute -left-1 top-4 w-1 h-8 bg-yellow-400 rounded-r"></div>
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-bold text-yellow-50">Topic / Trigger</h3>
                                <span class="text-[10px] bg-yellow-500/20 text-yellow-400 px-1.5 rounded">INPUT</span>
                            </div>
                            <textarea id="flow-prompt"
                                class="w-full h-24 bg-black/30 border border-gray-700 rounded p-2 text-sm text-gray-300 resize-none focus:outline-none focus:border-yellow-500 transition"
                                placeholder="Describe your automation workflow..."></textarea>
                            <button
                                onclick="FlowEngine.generateFromPrompt(document.getElementById('flow-prompt').value)"
                                class="mt-3 w-full py-2 bg-yellow-500 hover:bg-yellow-400 text-black font-bold text-sm rounded transition">
                                ✨ Generate Flow
                            </button>
                        </div>
                    </div>

                    <!-- Infinite Canvas -->
                    <div id="flow-canvas-container"
                        class="flex-1 flow-grid relative overflow-hidden cursor-grab active:cursor-grabbing">
                        <!-- Transformation Layer -->
                        <div id="flow-canvas" class="absolute inset-0 w-[5000px] h-[5000px] origin-top-left">
                            <!-- Connections (SVG) -->
                            <svg id="flow-connections-layer"
                                class="absolute inset-0 w-full h-full pointer-events-none overflow-visible"></svg>
                            <!-- Nodes (HTML) -->
                            <div id="flow-nodes-layer" class="absolute inset-0 w-full h-full pointer-events-auto"></div>
                        </div>
                    </div>
                </div>

                <!-- Exhibition -->
                <div id="exhibition" class="tab-content">
                    <h2 class="text-3xl font-black mb-8" style="color: var(--text-primary);">展会作战室</h2>
                    <div class="grid grid-cols-12 gap-6">
                        <!-- Left: Add & List -->
                        <div class="col-span-4 space-y-4">
                            <div class="panel">
                                <h3 class="font-bold mb-4" style="color: var(--text-primary);">添加计划</h3>
                                <input type="text" id="expo-name" placeholder="展会名称" class="input-box mb-3">
                                <input type="text" id="expo-booth" placeholder="展位号 (如: 3A-102)" class="input-box mb-3">
                                <select id="expo-prod" class="input-box mb-3">
                                    <option value="">-- 选择主推产品 --</option>
                                </select>
                                <input type="date" id="expo-date" class="input-box mb-4">
                                <button onclick="addExpo()" class="btn-primary w-full">加入作战图</button>
                            </div>
                            <div id="expo-list-container" class="space-y-2 h-[400px] overflow-y-auto">
                                <div class="text-center py-10" style="color: var(--text-secondary);">暂无计划</div>
                            </div>
                        </div>

                        <!-- Right: Action Area (AI Kit & Checklist) -->
                        <div class="col-span-8">
                            <div id="expo-detail-panel" class="panel h-full flex flex-col relative overflow-hidden">
                                <!-- Header -->
                                <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-4">
                                    <h3 class="font-bold text-xl" style="color: var(--text-primary);" id="detail-title">
                                        请选择展会 (Select Event)</h3>
                                    <div class="flex gap-2" id="detail-actions">
                                        <button onclick="toggleStandbyMode(true)"
                                            class="btn-primary flex items-center gap-2"
                                            style="background: linear-gradient(90deg, #6366f1, #4f46e5);">
                                            <span>🖥️</span> 大屏待机 (Big Screen)
                                        </button>
                                        <button onclick="toggleLiveMode()" class="btn-primary flex items-center gap-2"
                                            style="background: linear-gradient(90deg, #f59e0b, #d97706);">
                                            <span>⚡</span> 现场极速模式 (Live Mode)
                                        </button>
                                    </div>
                                </div>

                                <!-- Default View (Checklist/Details) -->
                                <div id="detail-content" class="flex-1 overflow-y-auto">
                                    <div class="text-center py-20 text-gray-500">
                                        <div class="text-4xl mb-4">🎪</div>
                                        点击左侧列表查看详情 或 开启现场模式
                                    </div>
                                </div>

                                <!-- Live Mode View (Hidden by default) -->
                                <div id="expo-live-mode"
                                    class="hidden absolute inset-0 bg-slate-900 z-20 flex flex-col p-6">
                                    <div class="flex justify-between items-center mb-6">
                                        <h3 class="text-2xl font-black text-yellow-500">⚡ Live Capture</h3>
                                        <button onclick="toggleLiveMode()" class="text-gray-400 hover:text-white">✕
                                            Close</button>
                                    </div>

                                    <div class="grid grid-cols-2 gap-8 h-full">
                                        <!-- Left: Camera/Upload -->
                                        <div class="border-2 border-dashed border-gray-700 rounded-xl flex flex-col items-center justify-center relative hover:border-yellow-500 transition cursor-pointer"
                                            onclick="document.getElementById('card-upload').click()">
                                            <div id="camera-placeholder" class="text-center">
                                                <div class="text-6xl mb-4">📸</div>
                                                <p class="font-bold text-gray-300">点击拍照 / 上传名片</p>
                                                <p class="text-xs text-gray-500 mt-2">支持 JPG/PNG • AI 自动识别</p>
                                            </div>
                                            <img id="card-preview"
                                                class="hidden absolute inset-0 w-full h-full object-contain bg-black/50 p-2">
                                            <input type="file" id="card-upload" class="hidden" accept="image/*"
                                                onchange="handleCardUpload(this)">

                                            <!-- OCR Loading Overlay -->
                                            <div id="ocr-loading"
                                                class="hidden absolute inset-0 bg-black/80 flex flex-col items-center justify-center">
                                                <div class="animate-spin text-4xl mb-2">⚡</div>
                                                <div class="text-yellow-500 font-mono text-xs animate-pulse">Scanning
                                                    Business Card...</div>
                                            </div>
                                        </div>

                                        <!-- Right: Form & Action -->
                                        <div class="flex flex-col gap-4 overflow-y-auto">
                                            <div class="grid grid-cols-2 gap-4">
                                                <input type="text" id="live-name" placeholder="客户姓名 (Name)"
                                                    class="input-box">
                                                <input type="text" id="live-company" placeholder="公司 (Company)"
                                                    class="input-box">
                                                <input type="email" id="live-email" placeholder="邮箱 (Email)"
                                                    class="input-box col-span-2">
                                            </div>

                                            <div class="flex gap-2">
                                                <select id="live-interest" class="input-box flex-1">
                                                    <option value="High">🔥 High Interest</option>
                                                    <option value="Medium">❄️ Medium</option>
                                                    <option value="Low">🧊 Low</option>
                                                </select>
                                                <input type="text" id="live-product" placeholder="意向产品..."
                                                    class="input-box flex-1">
                                            </div>

                                            <div class="flex-1 flex flex-col">
                                                <div class="flex justify-between items-center mb-2">
                                                    <label class="text-xs font-bold text-blue-400 uppercase">⚡ 闪电跟进
                                                        (Instant
                                                        Follow-up)</label>
                                                    <button onclick="generateInstantFollowUp()"
                                                        class="text-xs text-yellow-500 hover:text-white">✨ AI
                                                        生成</button>
                                                </div>
                                                <textarea id="live-draft"
                                                    class="input-box flex-1 font-mono text-xs leading-relaxed resize-none p-3"
                                                    placeholder="邮件草稿将在此生成..."></textarea>
                                            </div>

                                            <button onclick="saveLeadAndSend()" class="btn-primary w-full py-3"
                                                style="background: linear-gradient(90deg, #10b981, #059669);">
                                                💾 保存线索 & 复制草稿
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ad Doctor -->
                <div id="ad-doctor" class="tab-content">
                    <h2 class="text-3xl font-black mb-2" style="color: var(--text-primary);">广告会诊中心 (Ad Doctor)</h2>
                    <p class="text-sm mb-6" style="color: var(--text-secondary);">AI Diagnostic Lab · 首席投放师为您诊断 (Senior
                        Media Buyer Mode)</p>

                    <div class="grid grid-cols-12 gap-6 h-[600px]">
                        <!-- Left: Data Input Board -->
                        <div class="col-span-12 lg:col-span-5 flex flex-col gap-4">
                            <div class="panel flex-1 flex flex-col">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-bold text-blue-400 flex items-center gap-2">
                                        <span>📊</span> 数据看板 (Data Board)
                                    </h3>
                                    <div class="flex items-center gap-2">
                                        <label
                                            class="cursor-pointer bg-slate-700 hover:bg-slate-600 text-xs text-white px-2 py-1 rounded border border-gray-600 flex items-center gap-1 transition">
                                            <span>📂 导入表格</span>
                                            <input type="file" id="ad-file-upload" accept=".csv, .xlsx, .xls"
                                                class="hidden" onchange="handleAdFileUpload(this)">
                                        </label>
                                        <select id="platform-select"
                                            class="bg-slate-800 text-xs text-white p-1 rounded border border-gray-600 outline-none">
                                            <option value="TikTok">TikTok Ads</option>
                                            <option value="Google Ads">Google Ads</option>
                                            <option value="Facebook/Meta">Meta (FB/INS)</option>
                                            <option value="Amazon PPC">Amazon PPC</option>
                                        </select>
                                    </div>
                                </div>

                                <textarea id="ad-data-input"
                                    class="flex-1 w-full bg-black/30 border border-gray-700 rounded-lg p-3 font-mono text-xs leading-relaxed text-gray-300 resize-none focus:border-blue-500 focus:outline-none"
                                    placeholder="请在此粘贴您的广告数据表格 (支持从 Excel/CSV 直接复制)...
Example:
Ad Name | Spend | CTR | CPA | ROAS
Campaign A | $500 | 1.2% | $15 | 3.2
Campaign B | $1200 | 0.8% | $45 | 1.1
..."></textarea>

                                <div class="mt-4 flex gap-3">
                                    <button onclick="clearAdData()"
                                        class="px-4 py-2 text-gray-400 text-xs hover:text-white transition">清空</button>
                                    <button onclick="analyzeAdsWithAI()"
                                        class="flex-1 btn-primary shadow-lg shadow-purple-900/50"
                                        style="background: linear-gradient(135deg, #8b5cf6, #6d28d9);">
                                        🤖 启动深度会诊 (Deep Diagnose)
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Diagnosis Report -->
                        <div class="col-span-12 lg:col-span-7">
                            <div id="ad-doctor-result" class="panel h-full relative overflow-y-auto">
                                <!-- Placeholder -->
                                <div id="ad-doctor-placeholder"
                                    class="absolute inset-0 flex flex-col items-center justify-center text-gray-600 opacity-60">
                                    <div class="text-6xl mb-4">🩺</div>
                                    <p>等待数据输入...</p>
                                    <p class="text-xs mt-2">支持多维度数据交叉分析</p>
                                </div>

                                <!-- Loading Overlay -->
                                <div id="ad-doctor-loading"
                                    class="hidden absolute inset-0 z-10 bg-slate-900/90 flex flex-col items-center justify-center">
                                    <div class="text-4xl animate-bounce mb-4">🧠</div>
                                    <div class="text-purple-400 font-bold animate-pulse">正在进行千万级数据模型推演...</div>
                                    <div class="text-xs text-gray-500 mt-2 font-mono">Checking Creative Fatigue • ROAS
                                        Analysis • Bid Strategy</div>
                                </div>

                                <!-- Report Content -->
                                <div id="ad-doctor-content" class="hidden space-y-6 pb-10">
                                    <!-- Score Header -->
                                    <div class="flex items-center justify-between border-b border-gray-700 pb-4">
                                        <div>
                                            <div class="text-xs text-gray-400 uppercase">Health Score</div>
                                            <div class="text-4xl font-black text-white" id="ad-health-score">--</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-xs text-gray-400 uppercase">Diagnosis Status</div>
                                            <div class="px-3 py-1 rounded bg-purple-500/20 text-purple-300 text-sm font-bold border border-purple-500/30"
                                                id="ad-health-tag">
                                                Generating...
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 1. Hidden Gems (Opportunities) -->
                                    <div class="panel bg-green-500/10 border-green-500/20">
                                        <h4 class="text-green-400 font-bold mb-3 flex items-center gap-2">
                                            💎 潜龙挖掘 (Hidden Gems)
                                        </h4>
                                        <ul id="ad-gems-list"
                                            class="space-y-2 text-sm text-gray-800 dark:text-gray-300 list-disc pl-4">
                                        </ul>
                                    </div>

                                    <!-- 2. Budget Wasters (Risks) -->
                                    <div class="panel bg-red-500/10 border-red-500/20">
                                        <h4 class="text-red-400 font-bold mb-3 flex items-center gap-2">
                                            💸 预算黑洞 (Budget Wasters)
                                        </h4>
                                        <ul id="ad-wasters-list"
                                            class="space-y-2 text-sm text-gray-800 dark:text-gray-300 list-disc pl-4">
                                        </ul>
                                    </div>

                                    <!-- 3. Strategic Advice -->
                                    <div>
                                        <h4 class="text-blue-400 font-bold mb-3 uppercase text-xs">📈 首席投放建议 (Senior
                                            Strategy)</h4>
                                        <div id="ad-strategy-content"
                                            class="p-4 rounded bg-gray-100 border border-gray-200 text-gray-800 dark:bg-black/40 dark:border-gray-700 dark:text-gray-300 font-mono text-sm leading-relaxed">
                                        </div>
                                    </div>

                                    <!-- 4. Ask Data Doctor (New) -->
                                    <div class="pt-4 border-t border-gray-700">
                                        <h4
                                            class="text-purple-400 font-bold mb-3 uppercase text-xs flex items-center gap-2">
                                            <span>💬</span> 追问数据 (Ask Data)
                                        </h4>
                                        <div class="flex gap-2">
                                            <input type="text" id="ad-qa-input"
                                                class="flex-1 bg-slate-800 border border-gray-600 rounded px-3 py-2 text-sm text-white focus:border-purple-500 outline-none placeholder-gray-500"
                                                placeholder="比如：这两个的 CPM 分别是多少？"
                                                onkeypress="if(event.key === 'Enter') askAdDoctor()">
                                            <button onclick="askAdDoctor()"
                                                class="btn-primary bg-purple-600 hover:bg-purple-500 px-4 py-2 text-sm">
                                                发送
                                            </button>
                                        </div>
                                        <div id="ad-qa-result" class="mt-3 text-sm hidden p-3 rounded border font-medium
                                        bg-purple-50 text-purple-900 border-purple-200
                                        dark:bg-purple-900/40 dark:text-purple-100 dark:border-purple-500/30"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Budget -->
                <div id="budget" class="tab-content">
                    <div class="flex justify-between items-end mb-6">
                        <div>
                            <h2 class="text-3xl font-black mb-2" style="color: var(--text-primary);">资金指挥部 (Funds HQ)
                            </h2>
                            <p class="text-sm" style="color: var(--text-secondary);">Multi-Channel Budgeting · 分渠道独立核算
                            </p>
                        </div>
                        <button onclick="addChannel()" class="btn-primary"
                            style="background: linear-gradient(90deg, #10b981, #059669);">
                            + 新增渠道 (Add Channel)
                        </button>
                    </div>

                    <!-- Global Summary -->
                    <div class="grid grid-cols-3 gap-6 mb-8">
                        <div class="panel text-center">
                            <p class="text-xs font-bold text-blue-400 uppercase mb-2">总预算 (Total Allocation)</p>
                            <div class="text-3xl font-black font-mono" id="global-total"
                                style="color: var(--text-primary);">
                                ¥0</div>
                        </div>
                        <div class="panel text-center">
                            <p class="text-xs font-bold text-yellow-500 uppercase mb-2">总消耗 (Total Spent)</p>
                            <div class="text-3xl font-black font-mono text-yellow-500" id="global-spent">¥0</div>
                        </div>
                        <div class="panel text-center">
                            <p class="text-xs font-bold text-green-500 uppercase mb-2">剩余资金 (Remaining)</p>
                            <div class="text-3xl font-black font-mono text-green-500" id="global-remain">¥0</div>
                        </div>
                    </div>

                    <!-- Channel List Header -->
                    <div class="grid grid-cols-12 gap-4 px-4 mb-2 text-xs font-bold uppercase"
                        style="color: var(--text-secondary);">
                        <div class="col-span-3">渠道名称 (Channel)</div>
                        <div class="col-span-3 text-right">预算 (Budget)</div>
                        <div class="col-span-3 text-right">已花 (Spent)</div>
                        <div class="col-span-2 text-center">进度 (Usage)</div>
                        <div class="col-span-1 text-center">操作</div>
                    </div>

                    <!-- Dynamic Channel Container -->
                    <div id="budget-channel-list" class="space-y-3 pb-20">
                        <!-- Channels will be rendered here via JS -->
                    </div>
                </div>

                <!-- Automation Workflows -->
                <div id="automation" class="tab-content">
                    <h2 class="text-3xl font-black mb-2" style="color: var(--text-primary);">自动化工作流 (n8n)</h2>
                    <p class="text-sm mb-8" style="color: var(--text-secondary);">Connect & Automate · 连接外部世界</p>

                    <div class="grid grid-cols-12 gap-6">
                        <!-- Config Panel -->
                        <div class="col-span-12 panel mb-4">
                            <div class="flex items-end gap-4">
                                <div class="flex-1">
                                    <label class="block text-xs font-bold text-blue-400 uppercase mb-2">n8n Webhook
                                        URL</label>
                                    <input type="password" id="n8n-webhook-url" class="input-box font-mono text-sm"
                                        placeholder="https://your-n8n-instance.com/webhook/..."
                                        onchange="saveN8nConfig()">
                                </div>
                                <button onclick="testN8nConnection()" class="btn-primary"
                                    style="background: linear-gradient(90deg, #ff6b6b, #ee5253);">🔌 测试连接</button>
                            </div>
                            <p class="text-xs mt-2 text-gray-500">配置 n8n 的 Production Webhook URL 以启用实时自动化。</p>
                        </div>

                        <!-- Trigger Cards -->
                        <div class="col-span-4 panel border-l-4 border-purple-500">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="font-bold text-lg" style="color: var(--text-primary);">新线索捕获</h3>
                                <span class="text-2xl">🎣</span>
                            </div>
                            <p class="text-xs mb-4" style="color: var(--text-secondary);">模拟从着陆页捕获新线索，并发送至 CRM/Slack。
                            </p>
                            <button onclick="triggerWorkflow('lead_capture')"
                                class="w-full py-2 rounded bg-purple-600/20 hover:bg-purple-600/40 text-purple-300 border border-purple-500/30 transition">
                                🚀 触发模拟
                            </button>
                        </div>

                        <div class="col-span-4 panel border-l-4 border-blue-500">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="font-bold text-lg" style="color: var(--text-primary);">周报生成</h3>
                                <span class="text-2xl">📊</span>
                            </div>
                            <p class="text-xs mb-4" style="color: var(--text-secondary);">汇总本周数据 (Budget/CPL) 并发送至
                                Email。
                            </p>
                            <button onclick="triggerWorkflow('weekly_report')"
                                class="w-full py-2 rounded bg-blue-600/20 hover:bg-blue-600/40 text-blue-300 border border-blue-500/30 transition">
                                🚀 触发模拟
                            </button>
                        </div>

                        <div class="col-span-4 panel border-l-4 border-green-500">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="font-bold text-lg" style="color: var(--text-primary);">社媒同步</h3>
                                <span class="text-2xl">🔄</span>
                            </div>
                            <p class="text-xs mb-4" style="color: var(--text-secondary);">将生成的文案矩阵同步推送到
                                Buffer/Hootsuite。
                            </p>
                            <button onclick="triggerWorkflow('social_sync')"
                                class="w-full py-2 rounded bg-green-600/20 hover:bg-green-600/40 text-green-300 border border-green-500/30 transition">
                                🚀 触发模拟
                            </button>
                        </div>

                        <!-- Console/Log -->
                        <div class="col-span-12 panel mt-4">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-sm text-gray-400">运行日志 (Live)</h3>
                                <button onclick="document.getElementById('automation-log').innerHTML=''"
                                    class="text-xs text-gray-500 hover:text-white">清除</button>
                            </div>
                            <div id="automation-log"
                                class="h-40 overflow-y-auto font-mono text-xs text-green-400 p-2 bg-black/30 rounded border border-gray-700">
                                <div class="opacity-50">// 等待触发...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

    </div>

    <!-- Brand Content Command Center (Relaces Social Matrix) -->
    <div id="social-matrix" class="tab-content">
        <h2 class="text-3xl font-black mb-2" style="color: var(--text-primary);">品牌内容指挥部 (Brand Content)</h2>
        <p class="text-sm mb-6" style="color: var(--text-secondary);">Chief Content Officer AI · 全渠道内容矩阵生成引擎</p>

        <div class="grid grid-cols-12 gap-6 h-[700px]">
            <!-- Left: Strategy Console -->
            <div class="col-span-12 lg:col-span-4 flex flex-col gap-4">
                <div class="panel flex-1">
                    <h3 class="font-bold text-pink-400 mb-4 flex items-center gap-2">
                        <span>🎯</span> 核心策略 (Strategize)
                    </h3>

                    <label class="text-xs text-gray-500 uppercase mb-1 block">核心主题 (The "Big Idea")</label>
                    <input type="text" id="brand-theme" class="input-box mb-4">

                    <label class="text-xs text-gray-500 uppercase mb-1 block">产品/服务 (Subject)</label>
                    <input type="text" id="brand-product" class="input-box mb-4">

                    <label class="text-xs text-gray-500 uppercase mb-1 block">品牌语调 (Tone)</label>
                    <div class="grid grid-cols-3 gap-2 mb-6">
                        <button onclick="selectTone('Professional')" id="tone-pro"
                            class="tone-btn text-xs border border-pink-600 rounded py-1 hover:bg-pink-700 bg-pink-600 text-white">专业权威</button>
                        <button onclick="selectTone('Fun')" id="tone-fun"
                            class="tone-btn text-xs border border-gray-400 rounded py-1 hover:bg-gray-100 text-gray-500">幽默风趣</button>
                        <button onclick="selectTone('Inspirational')" id="tone-inspire"
                            class="tone-btn text-xs border border-gray-400 rounded py-1 hover:bg-gray-100 text-gray-500">激进振奋</button>
                    </div>
                    <input type="hidden" id="brand-tone" value="Professional">

                    <label class="text-xs text-gray-500 uppercase mb-1 block">输出语言 (Language)</label>
                    <select id="brand-lang" class="input-box mb-6">
                        <option value="Chinese" class="bg-gray-800 text-white">🇨🇳 中文 (Chinese)</option>
                        <option value="English" class="bg-gray-800 text-white">🇺🇸 English</option>
                        <option value="Spanish" class="bg-gray-800 text-white">🇪🇸 Spanish</option>
                        <option value="French" class="bg-gray-800 text-white">🇫🇷 French</option>
                        <option value="German" class="bg-gray-800 text-white">🇩🇪 German</option>
                        <option value="Japanese" class="bg-gray-800 text-white">🇯🇵 Japanese</option>
                    </select>

                    <!-- Platform Selection -->
                    <div class="mb-6">
                        <label class="text-xs text-gray-500 uppercase mb-2 block">目标发布平台 (Platforms)</label>
                        <div class="grid grid-cols-2 gap-2 text-sm text-gray-700">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" class="platform-checkbox form-checkbox text-blue-600 rounded"
                                    value="linkedin" checked>
                                <span>LinkedIn (B2B)</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" class="platform-checkbox form-checkbox text-black rounded"
                                    value="twitter" checked>
                                <span>X / Twitter</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" class="platform-checkbox form-checkbox text-pink-600 rounded"
                                    value="instagram" checked>
                                <span>Instagram</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" class="platform-checkbox form-checkbox text-orange-500 rounded"
                                    value="blog" checked>
                                <span>Blog / EDM</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" class="platform-checkbox form-checkbox text-blue-800 rounded"
                                    value="facebook" checked>
                                <span>Facebook</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" class="platform-checkbox form-checkbox text-red-600 rounded"
                                    value="youtube" checked>
                                <span>YouTube</span>
                            </label>
                        </div>
                    </div>

                    <button onclick="generateBrandContent()"
                        class="w-full btn-primary h-12 shadow-lg shadow-pink-900/50"
                        style="background: linear-gradient(135deg, #ec4899, #db2777);">
                        🚀 一键分发全网 (Launch Campaign)
                    </button>
                </div>
            </div>

            <!-- Right: Content Matrix Output -->
            <div class="col-span-12 lg:col-span-8 flex flex-col gap-4 overflow-y-auto">

                <!-- 0. Loading State -->
                <div id="brand-loading"
                    class="hidden h-full flex flex-col items-center justify-center panel border-pink-500/30">
                    <div class="text-4xl animate-bounce mb-4">💎</div>
                    <div class="text-pink-400 font-bold animate-pulse">正在构建品牌故事宇宙...</div>
                    <div class="text-xs text-gray-500 mt-2 font-mono">Strategizing • Copywriting • Visualizing</div>
                </div>

                <!-- 0. Placeholder -->
                <div id="brand-placeholder" class="h-full flex flex-col items-center justify-center panel opacity-50">
                    <div class="text-6xl mb-4">🌍</div>
                    <p>等待策略输入...</p>
                </div>

                <!-- 1. The Core Concept Card -->
                <div id="brand-core-card"
                    class="hidden panel bg-gradient-to-r from-pink-900/20 to-purple-900/20 border-pink-500/30">
                    <h3 class="text-pink-300 font-bold mb-2">💡 核心创意 (The Core Concept)</h3>
                    <p id="brand-core-text" class="text-lg italic text-white font-serif leading-relaxed">--</p>
                </div>

                <!-- 2. Channel Grid -->
                <div id="brand-channels" class="hidden grid grid-cols-2 gap-4">
                    <!-- LinkedIn -->
                    <div id="card-linkedin" class="panel border-t-4 border-blue-600">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-blue-400">LinkedIn (B2B)</span>
                            <span class="text-[10px] bg-blue-900/50 px-1 rounded text-blue-300">Thought
                                Leadership</span>
                        </div>
                        <div id="content-linkedin"
                            class="text-xs text-gray-800 dark:text-gray-200 whitespace-pre-wrap font-mono h-[150px] overflow-y-auto mb-2">
                        </div>
                        <button onclick="copyAndGo('linkedin', 'content-linkedin')"
                            class="w-full py-1 bg-blue-600/20 hover:bg-blue-600 text-blue-400 hover:text-white text-xs rounded transition border border-blue-600/30">
                            📋 Copy & Go
                        </button>
                    </div>

                    <!-- Twitter/X -->
                    <div id="card-twitter" class="panel border-t-4 border-black">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-gray-400">X (Twitter)</span>
                            <span class="text-[10px] bg-gray-800 px-1 rounded text-gray-300">Viral Hook</span>
                        </div>
                        <div id="content-twitter"
                            class="text-xs text-gray-800 dark:text-gray-200 whitespace-pre-wrap font-mono h-[150px] overflow-y-auto mb-2">
                        </div>
                        <button onclick="copyAndGo('twitter', 'content-twitter')"
                            class="w-full py-1 bg-gray-700/50 hover:bg-gray-700 text-gray-400 hover:text-white text-xs rounded transition border border-gray-600/30">
                            📋 Copy & Go
                        </button>
                    </div>

                    <!-- Instagram -->
                    <div id="card-instagram" class="panel border-t-4 border-pink-500">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-pink-400">Instagram</span>
                            <span class="text-[10px] bg-pink-900/50 px-1 rounded text-pink-300">Visual Story</span>
                        </div>
                        <div id="content-instagram"
                            class="text-xs text-gray-800 dark:text-gray-200 whitespace-pre-wrap font-mono h-[150px] overflow-y-auto mb-2">
                        </div>
                        <button onclick="copyAndGo('instagram', 'content-instagram')"
                            class="w-full py-1 bg-pink-600/20 hover:bg-pink-600 text-pink-400 hover:text-white text-xs rounded transition border border-pink-600/30">
                            📋 Copy & Go
                        </button>
                    </div>

                    <!-- Blog/EDM -->
                    <div id="card-blog" class="panel border-t-4 border-orange-500">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-orange-400">Blog / Newsletter</span>
                            <span class="text-[10px] bg-orange-900/50 px-1 rounded text-orange-300">SEO &
                                Value</span>
                        </div>
                        <div id="content-blog"
                            class="text-xs text-gray-800 dark:text-gray-200 whitespace-pre-wrap font-mono h-[150px] overflow-y-auto mb-2">
                        </div>
                        <button onclick="copyAndGo('blog', 'content-blog')"
                            class="w-full py-1 bg-orange-600/20 hover:bg-orange-600 text-orange-400 hover:text-white text-xs rounded transition border border-orange-600/30">
                            📋 Copy & Go
                        </button>
                    </div>

                    <!-- Facebook -->
                    <div id="card-facebook" class="panel border-t-4 border-blue-800 hidden">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-blue-400">Facebook</span>
                            <span class="text-[10px] bg-blue-900/50 px-1 rounded text-blue-200">Community &
                                Engagement</span>
                        </div>
                        <div id="content-facebook"
                            class="text-xs text-gray-800 dark:text-gray-200 whitespace-pre-wrap font-mono h-[150px] overflow-y-auto mb-2">
                        </div>
                        <button onclick="copyAndGo('facebook', 'content-facebook')"
                            class="w-full py-1 bg-blue-800/20 hover:bg-blue-800 text-blue-300 hover:text-white text-xs rounded transition border border-blue-800/30">
                            📋 Copy & Go
                        </button>
                    </div>

                    <!-- YouTube -->
                    <div id="card-youtube" class="panel border-t-4 border-red-600 hidden">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-red-500">YouTube</span>
                            <span class="text-[10px] bg-red-900/50 px-1 rounded text-red-200">SEO & Search</span>
                        </div>
                        <div id="content-youtube"
                            class="text-xs text-gray-800 dark:text-gray-200 whitespace-pre-wrap font-mono h-[150px] overflow-y-auto mb-2">
                        </div>
                        <button onclick="copyAndGo('youtube', 'content-youtube')"
                            class="w-full py-1 bg-red-600/20 hover:bg-red-600 text-red-400 hover:text-white text-xs rounded transition border border-red-600/30">
                            📋 Copy & Go
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Deep Dive (AI Intelligence Center) -->
    <div id="customer-deep-dive" class="tab-content relative h-full">
        <div class="h-full flex flex-col">
            <!-- 1. Hero Search Section (The "Google" View) -->
            <!-- CRM History Panel (Mini CRM) -->
            <div id="crm-panel-container" class="mb-6 px-8 pt-4">
                <button onclick="toggleCRMList()"
                    class="flex items-center gap-2 text-xs font-bold text-gray-500 hover:text-white transition mb-3">
                    <span id="crm-toggle-icon">▶</span>
                    <span>📁 客户档案库 (CRM History)</span>
                </button>
                <div id="crm-list-panel"
                    class="hidden panel bg-slate-900/50 border border-gray-700 max-h-60 overflow-y-auto w-full max-w-5xl mx-auto">
                    <div id="crm-list-content" class="space-y-2">
                        <!-- JS will render items here -->
                        <div class="text-center text-gray-400 py-4 text-xs font-mono">暂无存档记录</div>
                    </div>
                </div>
            </div>

            <!-- 1. Hero Search Section (The "Google" View) -->
            <div id="dive-hero-section"
                class="flex-1 flex flex-col items-center justify-center transition-all duration-500 pb-32">
                <div class="text-center mb-20">
                    <h2
                        class="text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 mb-8 animate-pulse-slow">
                        Morgan Intelligence
                    </h2>
                    <p class="text-gray-400 text-lg tracking-[0.3em] uppercase font-light">Global Business Due
                        Diligence
                        System
                    </p>
                </div>

                <!-- Search Box Container -->
                <div class="w-full max-w-3xl relative group mb-20">
                    <!-- Glow Effect -->
                    <div
                        class="absolute -inset-1 bg-gradient-to-r from-blue-600 to-purple-600 rounded-full blur opacity-25 group-hover:opacity-50 transition duration-1000">
                    </div>

                    <!-- Input -->
                    <div
                        class="relative bg-slate-900/80 backdrop-blur-xl rounded-full flex items-center p-4 border border-gray-700 shadow-2xl transition-transform transform group-hover:scale-[1.02]">
                        <div class="pl-6 pr-4 text-gray-400 text-3xl">🔍</div>
                        <input type="text" id="dive-url"
                            class="flex-1 bg-transparent text-white text-xl outline-none placeholder-gray-600 font-mono"
                            placeholder="输入目标官网 (e.g. www.anker.com)"
                            onkeypress="if(event.key==='Enter') startDeepDive()">
                        <button onclick="startDeepDive()"
                            class="bg-blue-600 hover:bg-blue-500 text-white px-10 py-4 rounded-full font-bold transition text-lg shadow-lg shadow-blue-900/50">
                            立即侦查
                        </button>
                    </div>
                </div>

                <!-- Mode Toggles (Cards) -->
                <div class="grid grid-cols-3 gap-8 w-full max-w-5xl px-4">
                    <!-- Mode: Audit -->
                    <button onclick="toggleDiveMode(this, 'audit')"
                        class="dive-mode-btn dive-mode-active group relative p-8 rounded-3xl border border-gray-800 bg-slate-900/50 hover:bg-slate-800 transition text-left shadow-2xl"
                        data-mode="audit">
                        <div
                            class="absolute inset-0 bg-blue-600/10 opacity-0 group-[.dive-mode-active]:opacity-100 rounded-3xl transition">
                        </div>
                        <div class="relative z-10">
                            <div
                                class="text-4xl mb-4 group-[.dive-mode-active]:scale-110 transition-transform origin-left">
                                🕵️‍♂️</div>
                            <h3 class="text-white text-xl font-bold mb-3 group-[.dive-mode-active]:text-blue-400">
                                深度审计
                                (Deep
                                Audit)
                            </h3>
                            <p class="text-sm text-gray-400 leading-relaxed font-medium">
                                全面体检。身份验证 · 信誉评分 · 策略建议
                            </p>
                        </div>
                    </button>

                    <!-- Mode: Quick -->
                    <button onclick="toggleDiveMode(this, 'quick')"
                        class="dive-mode-btn group relative p-8 rounded-3xl border border-gray-800 bg-slate-900/50 hover:bg-slate-800 transition text-left shadow-2xl"
                        data-mode="quick">
                        <div
                            class="absolute inset-0 bg-blue-600/10 opacity-0 group-[.dive-mode-active]:opacity-100 rounded-3xl transition">
                        </div>
                        <div class="relative z-10">
                            <div
                                class="text-4xl mb-4 group-[.dive-mode-active]:scale-110 transition-transform origin-left">
                                ⚡</div>
                            <h3 class="text-white text-xl font-bold mb-3 group-[.dive-mode-active]:text-yellow-400">
                                快速扫描
                                (Quick
                                Scan)
                            </h3>
                            <p class="text-sm text-gray-400 leading-relaxed font-medium">
                                核心速查。工厂验证 · 规模评估 · 风险预警
                            </p>
                        </div>
                    </button>

                    <!-- Mode: Hunter -->
                    <button onclick="toggleDiveMode(this, 'hunter')"
                        class="dive-mode-btn group relative p-8 rounded-3xl border border-gray-800 bg-slate-900/50 hover:bg-slate-800 transition text-left shadow-2xl"
                        data-mode="hunter">
                        <div
                            class="absolute inset-0 bg-blue-600/10 opacity-0 group-[.dive-mode-active]:opacity-100 rounded-3xl transition">
                        </div>
                        <div class="relative z-10">
                            <div
                                class="text-4xl mb-4 group-[.dive-mode-active]:scale-110 transition-transform origin-left">
                                📧</div>
                            <h3 class="text-white text-xl font-bold mb-3 group-[.dive-mode-active]:text-pink-400">
                                猎人模式
                                (Hunter)
                            </h3>
                            <p class="text-sm text-gray-400 leading-relaxed font-medium">
                                人脉挖掘。锁定关键人 · 邮箱 · 社媒足迹
                            </p>
                        </div>
                    </button>
                </div>
            </div>

            <!-- 2. Loading State (Hidden) -->
            <div id="dive-loading"
                class="hidden absolute inset-0 flex flex-col items-center justify-center bg-slate-900/90 z-20 backdrop-blur-sm">
                <div class="relative w-24 h-24 mb-6">
                    <div class="absolute inset-0 border-4 border-blue-500/30 rounded-full animate-ping"></div>
                    <div class="absolute inset-0 border-4 border-t-blue-500 rounded-full animate-spin"></div>
                    <div class="absolute inset-0 flex items-center justify-center text-2xl">🕵️‍♂️</div>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">正在潜入目标网络...</h3>
                <p class="text-blue-400 font-mono text-xs animate-pulse">Accessing Global Node via Jina Reader...
                </p>
                <div class="mt-4 flex gap-2 text-[10px] text-gray-500 font-mono">
                    <span>[HTTP 200]</span>
                    <span>[Parsing HTML]</span>
                    <span>[Extracting Tokens]</span>
                </div>
            </div>

            <!-- 3. Result Dashboard (Hidden initially) -->
            <div id="dive-dashboard" class="hidden flex-1 overflow-y-auto mt-4 animate-fadeIn">
                <div class="grid grid-cols-12 gap-6 pb-20">
                    <!-- Left: Profile Card -->
                    <div class="col-span-12 lg:col-span-4 space-y-4">
                        <!-- Identity Card -->
                        <div class="panel border-t-4 border-blue-500 bg-gradient-to-b from-slate-800 to-slate-900">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <div class="text-xs text-gray-500 uppercase font-bold tracking-wider">Business
                                        Identity</div>
                                    <div id="dive-identity" class="text-2xl font-black text-white mt-1">Loading...
                                    </div>
                                    <div id="dive-location" class="text-xs text-blue-400 mt-1 flex items-center gap-1">
                                        📍 Scanning...</div>
                                </div>
                                <div class="flex flex-col items-center">
                                    <div id="trust-circle"
                                        class="w-16 h-16 rounded-full border-4 border-gray-700 flex items-center justify-center">
                                        <span id="dive-score" class="text-xl font-bold text-white">--</span>
                                    </div>
                                    <span class="text-[10px] text-gray-500 mt-1 uppercase">Trust Score</span>
                                </div>
                            </div>
                            <div
                                class="bg-black/20 rounded p-3 text-xs text-gray-400 leading-relaxed font-mono space-y-1">
                                <div>
                                    <span class="text-blue-400 font-bold">Business Model:</span>
                                    <span id="dive-model" class="text-gray-300">Analyzing...</span>
                                </div>
                                <div>
                                    <span class="text-green-400 font-bold">Scale Estimate:</span>
                                    <span id="dive-scale" class="text-gray-300">--</span>
                                </div>
                                <div>
                                    <span class="text-purple-400 font-bold">Key Products:</span>
                                    <span id="dive-products" class="text-gray-300">--</span>
                                </div>
                            </div>
                        </div>

                        <!-- Analysis Lists -->
                        <div class="panel">
                            <h4 class="font-bold text-gray-300 text-sm mb-3">✅ 优势 (Green Lights)</h4>
                            <ul id="dive-pro-list" class="space-y-2 mb-6"></ul>

                            <h4 class="font-bold text-gray-300 text-sm mb-3">⚠️ 风险 (Red Flags)</h4>
                            <ul id="dive-con-list" class="space-y-2"></ul>
                        </div>
                    </div>

                    <!-- Right: Actionable Intel -->
                    <div class="col-span-12 lg:col-span-8 space-y-4">
                        <!-- Pitch Strategy Hero -->
                        <div class="panel bg-gradient-to-r from-purple-900/40 to-blue-900/40 border border-blue-500/30">
                            <div class="flex items-center gap-3 mb-3">
                                <span class="text-2xl">🎯</span>
                                <h3 class="font-bold text-white">攻单策略 (How to Pitch)</h3>
                            </div>
                            <p id="dive-pitch" class="text-sm text-gray-200 leading-relaxed font-medium">Fetching
                                strategy...</p>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <!-- Contact Harvester -->
                            <div class="panel border-l-4 border-yellow-500">
                                <h4 class="font-bold text-yellow-500 text-sm mb-3 uppercase flex items-center gap-2">
                                    <span>📧</span> Emails Found
                                </h4>
                                <ul id="dive-contact-list" class="space-y-2 h-40 overflow-y-auto"></ul>
                            </div>

                            <!-- Social Matrix -->
                            <div class="panel border-l-4 border-pink-500">
                                <h4 class="font-bold text-pink-500 text-sm mb-3 uppercase flex items-center gap-2">
                                    <span>🔗</span> Social Footprint
                                </h4>
                                <ul id="dive-social-list" class="space-y-2 h-40 overflow-y-auto"></ul>
                            </div>
                        </div>

                        <!-- Action Bar -->
                        <div class="flex gap-4">
                            <button
                                onclick="document.getElementById('dive-hero-section').classList.remove('hidden'); document.getElementById('dive-dashboard').classList.add('hidden');"
                                class="flex-1 py-3 rounded-lg border border-gray-600 text-gray-400 hover:text-white hover:bg-gray-800 transition">
                                ↩️ 新搜索 (New Search)
                            </button>
                            ↩️ 新搜索 (New Search)
                            </button>
                            <button onclick="saveToCRM()"
                                class="flex-1 btn-primary py-3 bg-gradient-to-r from-emerald-600 to-teal-600 border border-teal-500/30">
                                💾 保存到 CRM (Save)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Price Calculator -->
    <div id="price-calculator" class="tab-content">
        <div class="flex justify-between items-end mb-6">
            <div>
                <h2 class="text-3xl font-black mb-2" style="color: var(--text-primary);">出口报价计算器 (Price
                    Calculator)
                </h2>
                <p class="text-sm" style="color: var(--text-secondary);">5-Layer Precision Model · 即使汇率波动也能守住利润
                </p>
            </div>
            <div class="flex gap-4 p-3 bg-slate-900 rounded-lg border border-gray-700">
                <div class="flex flex-col">
                    <label class="text-[10px] text-gray-400 font-bold uppercase">汇率 (USD/RMB)</label>
                    <input type="number" id="calc-rate"
                        class="bg-transparent text-yellow-500 font-mono font-bold w-20 outline-none" value="7.20"
                        onchange="runCalc()">
                </div>
                <div class="w-px bg-gray-700"></div>
                <div class="flex flex-col">
                    <label class="text-[10px] text-gray-400 font-bold uppercase">退税率 (Rebate %)</label>
                    <input type="number" id="calc-rebate"
                        class="bg-transparent text-blue-400 font-mono font-bold w-16 outline-none" value="13"
                        onchange="runCalc()">
                </div>
            </div>
        </div>

        <div class="grid grid-cols-12 gap-6">
            <!-- Left: Forward Calculation (Cost Building) -->
            <div class="col-span-7 space-y-4">
                <div class="panel">
                    <h3 class="text-blue-400 font-bold mb-4 flex items-center gap-2">
                        <span>🏗️</span> 成本构建 (Build Cost)
                    </h3>

                    <!-- Layer 1: Factory -->
                    <div class="grid grid-cols-3 gap-4 mb-4 pb-4 border-b border-gray-700">
                        <div class="col-span-1">
                            <label class="block text-xs text-gray-500 mb-1">采购价 (RMB)</label>
                            <input type="number" id="calc-factory-price" class="input-box font-mono"
                                placeholder="100.00" oninput="runCalc()">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-xs text-gray-500 mb-1">本次数量 (Qty)</label>
                            <input type="number" id="calc-qty" class="input-box font-mono" value="1000"
                                oninput="runCalc()">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-xs text-gray-500 mb-1">单件体积 (CBM)</label>
                            <input type="number" id="calc-cbm" class="input-box font-mono" value="0.05"
                                oninput="runCalc()">
                        </div>
                        <div class="col-span-3 text-right">
                            <span class="text-xs text-gray-500">实际采购成本(扣税后): </span>
                            <span id="calc-real-cost" class="text-sm font-mono text-white font-bold">¥0.00</span>
                        </div>
                    </div>

                    <!-- Layer 2: Logistics -->
                    <div class="grid grid-cols-3 gap-4 mb-4 pb-4 border-b border-gray-700">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">内陆运费 (RMB)</label>
                            <input type="number" id="calc-inland" class="input-box font-mono text-sm" value="500"
                                oninput="runCalc()">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">港杂费 (RMB)</label>
                            <input type="number" id="calc-port" class="input-box font-mono text-sm" value="1000"
                                oninput="runCalc()">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">海运/保费 ($)</label>
                            <input type="number" id="calc-sea" class="input-box font-mono text-sm" value="0"
                                placeholder="FOB填0" oninput="runCalc()">
                        </div>
                    </div>

                    <!-- Layer 3: Profit -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">目标利润率 (Margin %)</label>
                            <div class="flex items-center gap-2">
                                <input type="range" id="calc-margin-slider" min="0" max="50" value="20"
                                    class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
                                    oninput="runCalc()">
                                <input type="number" id="calc-margin"
                                    class="input-box w-16 text-center font-bold text-green-400" value="20"
                                    oninput="runCalc()">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">银行/佣金 (Buffer %)</label>
                            <input type="number" id="calc-comm" class="input-box font-mono" value="2"
                                oninput="runCalc()">
                        </div>
                    </div>

                    <!-- Result -->
                    <div
                        class="bg-slate-900/50 p-6 rounded-xl border border-blue-500/20 text-center relative overflow-hidden">
                        <div class="text-xs text-blue-400 uppercase tracking-widest mb-2 font-bold">Suggested
                            Quote
                            Price</div>
                        <div class="text-5xl font-black text-white font-mono tracking-tighter mb-2">
                            $<span id="calc-final-price">0.00</span>
                        </div>
                        <div class="flex justify-center gap-8 text-xs text-gray-500">
                            <span>Profit/Unit: <b class="text-green-500" id="calc-profit-unit">$0.00</b></span>
                            <span>Total Profit: <b class="text-green-500" id="calc-profit-total">$0.00</b></span>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-700 flex gap-3 justify-center">
                            <button onclick="generateQuotePDF()"
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white text-sm font-bold rounded-lg transition flex items-center gap-2">
                                📄 导出PDF报价单
                            </button>
                            <button onclick="copyQuoteToClipboard()"
                                class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-gray-300 text-sm font-bold rounded-lg transition flex items-center gap-2">
                                📋 复制报价
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Reverse & Tiered -->
            <div class="col-span-5 space-y-4">
                <!-- Reverse Calc -->
                <div class="panel border-l-4 border-yellow-500">
                    <h3 class="text-yellow-500 font-bold mb-4 flex items-center gap-2">
                        <span>🎯</span> 反向推算 (Reverse)
                    </h3>
                    <div class="flex gap-4 items-end">
                        <div class="flex-1">
                            <label class="block text-xs text-gray-500 mb-1">客户目标价 ($)</label>
                            <input type="number" id="calc-target-price" class="input-box font-mono"
                                placeholder="Target..." oninput="runReverseCalc()">
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-500">隐形利润率</div>
                            <div class="text-2xl font-bold font-mono" id="calc-reverse-margin">0.0%</div>
                        </div>
                    </div>
                </div>

                <!-- Tiered Table -->
                <div class="panel">
                    <h3 class="text-gray-400 font-bold mb-4 text-xs uppercase">
                        📊 阶梯模拟 (Volume Analysis)
                    </h3>
                    <table class="w-full text-xs font-mono text-left">
                        <thead class="text-gray-500 border-b border-gray-700">
                            <tr>
                                <th class="py-2">Qty</th>
                                <th class="py-2">Logistics/Unit</th>
                                <th class="py-2 text-right">FOB Price</th>
                            </tr>
                        </thead>
                        <tbody id="calc-tier-body" class="text-gray-300">
                            <!-- Dynamic -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Competitor Watch (New Phase 12) - Moved Here -->
    <div id="competitor-watch" class="tab-content">
        <h2 class="text-3xl font-black mb-2" style="color: var(--text-primary);">竞对情报局 ⚔️</h2>
        <p class="text-sm mb-8" style="color: var(--text-secondary);">知己知彼 · AI 降维打击分析</p>

        <div class="grid grid-cols-12 gap-6">
            <!-- Input -->
            <div class="col-span-5 panel">
                <label class="block text-xs font-bold text-blue-400 uppercase mb-2">竞争对手</label>
                <input type="text" id="comp-name" class="input-box mb-4" placeholder="例如：Competitor X">

                <label class="block text-xs font-bold text-blue-400 uppercase mb-2">情报素材</label>
                <textarea id="comp-text" class="input-box h-64 text-xs font-mono mb-4"
                    placeholder="粘贴竞对的广告文案、官网介绍或产品参数..."></textarea>

                <button onclick="analyzeCompetitor()"
                    class="btn-primary w-full bg-gradient-to-r from-red-600 to-orange-600 border border-red-500/30">
                    🔍 启动战术分析
                </button>
            </div>

            <!-- Output -->
            <div class="col-span-7 panel relative min-h-[500px]">
                <div class="absolute top-0 right-0 p-4 opacity-10 text-9xl pointer-events-none">🛡️</div>
                <h3 class="font-bold mb-4 text-xl" style="color: var(--text-primary);">战术分析报告</h3>
                <div id="comp-result"
                    class="space-y-4 text-sm text-gray-300 leading-relaxed overflow-y-auto max-h-[600px] pr-2">
                    <div class="text-center py-20 opacity-50">
                        等待情报输入...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 🆕 Phase 16: Email Template Library -->
    <div id="email-templates" class="tab-content">
        <h2 class="text-3xl font-black mb-2" style="color: var(--text-primary);">📧 邮件模板库</h2>
        <p class="text-sm mb-8" style="color: var(--text-secondary);">专业外贸邮件模板 · AI智能生成 · 多语言支持</p>

        <div class="grid grid-cols-12 gap-6">
            <!-- Left: Template List -->
            <div class="col-span-4 panel">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-white">模板列表</h3>
                    <button onclick="createNewTemplate()"
                        class="px-3 py-1 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold rounded-lg">+
                        新建</button>
                </div>
                <div class="space-y-1 mb-4">
                    <select id="template-category-filter" class="input-box w-full text-sm" onchange="filterTemplates()">
                        <option value="all">全部类别</option>
                        <option value="inquiry_reply">询盘回复</option>
                        <option value="follow_up">跟进邮件</option>
                        <option value="quote_send">报价发送</option>
                        <option value="sample_confirm">样品确认</option>
                        <option value="holiday">节日问候</option>
                        <option value="post_exhibition">展后感谢</option>
                    </select>
                </div>
                <div id="template-list" class="space-y-2 max-h-[500px] overflow-y-auto">
                    <div class="text-gray-500 text-sm text-center py-8">点击"新建"创建您的第一个模板</div>
                </div>
            </div>

            <!-- Right: Template Editor -->
            <div class="col-span-8 panel">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-white">模板编辑器</h3>
                    <div class="flex gap-2">
                        <button onclick="aiGenerateTemplate()"
                            class="px-3 py-1 bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold rounded-lg flex items-center gap-1">
                            🤖 AI生成
                        </button>
                        <button onclick="saveTemplate()"
                            class="px-3 py-1 bg-green-600 hover:bg-green-500 text-white text-xs font-bold rounded-lg">
                            💾 保存
                        </button>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="grid grid-cols-3 gap-4">
                        <input type="text" id="tpl-name" class="input-box" placeholder="模板名称...">
                        <select id="tpl-category" class="input-box">
                            <option value="inquiry_reply">询盘回复</option>
                            <option value="follow_up">跟进邮件</option>
                            <option value="quote_send">报价发送</option>
                            <option value="sample_confirm">样品确认</option>
                            <option value="holiday">节日问候</option>
                            <option value="post_exhibition">展后感谢</option>
                        </select>
                        <select id="tpl-lang" class="input-box">
                            <option value="English">English</option>
                            <option value="中文">中文</option>
                            <option value="Spanish">Spanish</option>
                            <option value="French">French</option>
                            <option value="German">German</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs text-gray-400 mb-1">邮件主题</label>
                        <input type="text" id="tpl-subject" class="input-box w-full"
                            placeholder="RE: Inquiry for {{产品名}}">
                    </div>

                    <div>
                        <label class="block text-xs text-gray-400 mb-1">邮件正文</label>
                        <textarea id="tpl-content" class="input-box w-full h-64 font-mono text-sm" placeholder="Dear {{客户名}},

Thank you for your inquiry about our {{产品名}}...

Best regards,
{{我方姓名}}
{{公司名}}"></textarea>
                    </div>

                    <!-- Variable Chips -->
                    <div class="flex flex-wrap gap-2">
                        <span class="text-xs text-gray-500">可用变量：</span>
                        <button onclick="insertVariable('{{客户名}}')"
                            class="px-2 py-1 bg-slate-700 hover:bg-slate-600 text-blue-400 text-xs rounded">[客户名]</button>
                        <button onclick="insertVariable('{{公司名}}')"
                            class="px-2 py-1 bg-slate-700 hover:bg-slate-600 text-blue-400 text-xs rounded">[公司名]</button>
                        <button onclick="insertVariable('{{产品名}}')"
                            class="px-2 py-1 bg-slate-700 hover:bg-slate-600 text-blue-400 text-xs rounded">[产品名]</button>
                        <button onclick="insertVariable('{{报价金额}}')"
                            class="px-2 py-1 bg-slate-700 hover:bg-slate-600 text-blue-400 text-xs rounded">[报价金额]</button>
                        <button onclick="insertVariable('{{交期}}')"
                            class="px-2 py-1 bg-slate-700 hover:bg-slate-600 text-blue-400 text-xs rounded">[交期]</button>
                        <button onclick="insertVariable('{{我方姓名}}')"
                            class="px-2 py-1 bg-slate-700 hover:bg-slate-600 text-blue-400 text-xs rounded">[我方姓名]</button>
                    </div>
                </div>

                <!-- Preview Area -->
                <div class="mt-6 pt-4 border-t border-gray-700">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs text-gray-400">预览</span>
                        <button onclick="copyTemplateContent()" class="text-xs text-blue-400 hover:text-blue-300">📋
                            复制内容</button>
                    </div>
                    <div id="tpl-preview" class="bg-slate-900/50 p-4 rounded-lg text-sm text-gray-300 min-h-[100px]">
                        <em class="text-gray-500">编辑内容后在此预览...</em>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Competitor Watch (New Phase 12) - Moved Here -->
    <div id="competitor-watch" class="tab-content">
        <h2 class="text-3xl font-black mb-2" style="color: var(--text-primary);">竞对情报局 ⚔️</h2>
        <p class="text-sm mb-8" style="color: var(--text-secondary);">知己知彼 · AI 降维打击分析</p>

        <div class="grid grid-cols-12 gap-6">
            <!-- Input -->
            <div class="col-span-5 panel">
                <label class="block text-xs font-bold text-blue-400 uppercase mb-2">竞争对手</label>
                <input type="text" id="comp-name" class="input-box mb-4" placeholder="例如：Competitor X">

                <label class="block text-xs font-bold text-blue-400 uppercase mb-2">情报素材</label>
                <textarea id="comp-text" class="input-box h-64 text-xs font-mono mb-4"
                    placeholder="粘贴竞对的广告文案、官网介绍或产品参数..."></textarea>

                <button onclick="analyzeCompetitor()"
                    class="btn-primary w-full bg-gradient-to-r from-red-600 to-orange-600 border border-red-500/30">
                    🔍 启动战术分析
                </button>
            </div>

            <!-- Output -->
            <div class="col-span-7 panel relative min-h-[500px]">
                <div class="absolute top-0 right-0 p-4 opacity-10 text-9xl pointer-events-none">🛡️</div>
                <h3 class="font-bold mb-4 text-xl" style="color: var(--text-primary);">战术分析报告</h3>
                <div id="comp-result"
                    class="space-y-4 text-sm text-gray-300 leading-relaxed overflow-y-auto max-h-[600px] pr-2">
                    <div class="text-center py-20 opacity-50">
                        等待情报输入...
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    </main>

    <!-- Exhibition Standby Overlay (v18.2) -->
    <div id="standby-overlay"
        class="hidden fixed inset-0 z-[100] bg-black cursor-pointer overflow-hidden transition-all duration-1000 opacity-0"
        onclick="toggleStandbyMode(false)">


        <!-- Dynamic Background -->
        <div class="absolute inset-0 bg-gradient-to-br from-slate-900 via-blue-900/20 to-black z-0"></div>
        <div
            class="absolute inset-0 z-0 opacity-30 animate-pulse-slow bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-blue-600 via-transparent to-transparent">
        </div>

        <!-- Content -->
        <div class="relative z-10 flex flex-col items-center justify-center h-full text-center">
            <h1 class="text-[12rem] font-black text-transparent bg-clip-text bg-gradient-to-b from-white to-gray-400 font-mono tracking-tighter mb-4 drop-shadow-[0_0_80px_rgba(59,130,246,0.5)] leading-none"
                id="standby-clock">
                00:00
            </h1>
            <p
                class="text-3xl text-blue-400 font-light tracking-[0.8em] uppercase mb-16 border-t border-blue-900/50 pt-8">
                Morgan Marketing OS</p>

            <div class="animate-bounce mt-12">
                <span
                    class="px-8 py-3 rounded-full border border-white/10 text-white/50 text-sm uppercase tracking-widest backdrop-blur-md bg-white/5 hover:bg-white/10 transition">
                    Touch to Wake
                </span>
            </div>
        </div>
    </div>

    <!-- Paste Modal -->
    <div id="paste-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg w-full max-w-2xl border border-gray-700 shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-4">输入文本资料</h3>
            <textarea id="paste-content"
                class="w-full h-64 bg-gray-900 border border-gray-700 rounded p-4 text-gray-300 font-mono text-sm focus:border-blue-500 outline-none resize-none"
                placeholder="在此粘贴文本内容..."></textarea>
            <div class="flex justify-end gap-3 mt-4">
                <button onclick="document.getElementById('paste-modal').classList.add('hidden')"
                    class="px-4 py-2 text-gray-400 hover:text-white">取消</button>
                <button onclick="submitPasteContent()"
                    class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded font-medium">✨ 存入大脑</button>
            </div>
        </div>
    </div>

    <!-- Global Script Loading Order (Fixed) -->
    <script src="app_part_standby.js"></script>
    <script src="app_part_radar.js"></script>
    <script src="app_part_calc.js"></script>
    <script src="app_part_calendar.js"></script> <!-- Smart Calendar Module -->
    <script src="app_part_adoracle.js"></script> <!-- AdOracle Module -->
    <script src="app_part_rag.js"></script> <!-- Smart RAG Module -->
    <script src="app_part_deepdive.js"></script> <!-- Customer Deep Dive Module -->
    <script src="app_part_rfq.js"></script>
    <script src="app_part_workflow.js"></script>
    <!-- Mobile Overlay -->
    <div id="sidebar-overlay" onclick="toggleSidebar()"
        class="fixed inset-0 bg-black/50 z-30 hidden md:hidden backdrop-blur-sm transition-opacity opacity-0">
    </div>



    <!-- Auth Modal (Added for Phase 18) -->
    <div id="auth-modal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm hidden">
        <div class="bg-gray-900 border border-gray-700 p-8 rounded-2xl w-96 shadow-2xl relative">
            <h2
                class="text-2xl font-black mb-6 text-center bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-600">
                Morgan.OS ID</h2>

            <div id="auth-form" class="space-y-4">
                <div class="relative group">
                    <div
                        class="absolute -inset-0.5 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl opacity-30 group-hover:opacity-100 transition duration-500 blur">
                    </div>
                    <input type="email" id="auth-email"
                        class="relative block w-full bg-slate-800/80 text-white placeholder-gray-500 border border-white/10 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-slate-800 transition-all font-medium"
                        placeholder="name@morgan.com">
                </div>

                <div class="relative group">
                    <div
                        class="absolute -inset-0.5 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl opacity-30 group-hover:opacity-100 transition duration-500 blur">
                    </div>
                    <input type="password" id="auth-password"
                        class="relative block w-full bg-slate-800/80 text-white placeholder-gray-500 border border-white/10 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-slate-800 transition-all font-medium"
                        placeholder="••••••••">
                </div>

                <div id="auth-error"
                    class="hidden p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400 text-xs text-center font-medium animate-shake">
                </div>

                <button onclick="handleAuthSubmit()" id="auth-submit-btn"
                    class="w-full py-3.5 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-bold rounded-xl shadow-lg shadow-blue-600/30 transition-all duration-300 transform active:scale-95 flex items-center justify-center gap-2 group">
                    <span>Login</span>
                    <span class="group-hover:translate-x-1 transition-transform">→</span>
                </button>

                <div class="flex items-center justify-between text-xs text-gray-400 mt-6 pt-4 border-t border-white/5">
                    <span id="auth-mode-text">Need an account?</span>
                    <button onclick="toggleAuthMode()" id="auth-toggle-btn"
                        class="text-blue-400 hover:text-blue-300 font-bold transition-colors">Create Account</button>
                </div>

                <!-- 🧪 Sandbox Mode (Hidden by default, shown on error) -->
                <div id="guest-login-div" class="hidden mt-4 pt-3 border-t border-white/5 text-center animate-fade-in">
                    <button onclick="handleGuestLogin()"
                        class="text-xs text-gray-500 hover:text-white transition-colors flex items-center justify-center gap-1 mx-auto group">
                        <span class="grayscale group-hover:grayscale-0 transition">🧪</span>
                        <span>Sandbox Mode (Skip Login)</span>
                    </button>
                </div>
            </div>

            <script>
                // Inline Auth Logic (v18.21 FALLBACK FIXED)
                let isRegisterMode = false;
                let isLoading = false;

                // 🛡️ Robust Initialization for Auth Modal
                // Ensure window.sb exists before app.js even loads
                (function initFastAuth() {
                    const SUPABASE_URL = 'https://ftcaijvfvypcwjgetkvp.supabase.co';
                    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ0Y2FpanZmdnlwY3dqZ2V0a3ZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1NzM0MDYsImV4cCI6MjA4MDE0OTQwNn0.TQ-ayMDAVizgCxEly_ahflzZYXnBYhQ1sBjQnZ636gQ';

                    // 🚀 GUEST MODE BYPASS
                    if (window.location.search.includes('guest=true')) {
                        console.warn('🔓 GUEST MODE ACTIVATED: Setting global flag');

                        // 🎯 CRITICAL: Set global flag FIRST - this tells initAuth() to skip everything
                        window.isGuestMode = true;

                        window.sb = {
                            auth: {
                                getSession: async () => ({
                                    data: {
                                        session: {
                                            user: { id: 'guest-007', email: 'guest@morgan.com', role: 'authenticated' }
                                        }
                                    },
                                    error: null
                                }),
                                onAuthStateChange: (cb) => {
                                    // Immediately simulate sign-in
                                    setTimeout(() => cb('SIGNED_IN', {
                                        user: { id: 'guest-007', email: 'guest@morgan.com' }
                                    }), 100);
                                    return { data: { subscription: { unsubscribe: () => { } } } };
                                },
                                signOut: async () => { window.location.href = window.location.pathname; }, // Clear query param
                                signUp: async () => ({ error: { message: "Guest mode cannot register." } }),
                                signInWithPassword: async () => ({ error: { message: "Already logged in as Guest." } })
                            },
                            from: (table) => {
                                console.log(`[MockDB] Select from ${table}`);
                                return {
                                    select: () => ({
                                        eq: () => ({
                                            single: async () => {
                                                if (table === 'profiles') {
                                                    return { data: { role: 'admin', allowed_modules: ['dashboard', 'deepdive', 'calc', 'tracker', 'radar', 'knowledge'] }, error: null };
                                                }
                                                return { data: null, error: null };
                                            },
                                            maybeSingle: async () => ({ data: null, error: null })
                                        })
                                    })
                                };
                            }
                        };

                        // 🎯 Guest Mode: Hide auth modal and show main app IMMEDIATELY
                        document.addEventListener('DOMContentLoaded', () => {
                            const authModal = document.getElementById('auth-modal');
                            if (authModal) authModal.classList.add('hidden');

                            const appMain = document.getElementById('app-main');
                            if (appMain) appMain.classList.remove('hidden');

                            // Update user display
                            const userInfo = document.getElementById('user-info-display');
                            if (userInfo) {
                                userInfo.innerHTML = `
                                    <div class="text-xs text-gray-400">Demo Mode</div>
                                    <div class="font-bold text-green-400">🧪 Guest</div>
                                    <div class="text-[10px] text-gray-500">ADMIN</div>
                                `;
                            }
                            console.log('🏠 Guest Mode: App entrance complete!');
                        });

                        return;
                    }

                    if (window.supabase) {
                        try {
                            window.sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                            console.log('✅ Fast Auth Client Initialized');
                        } catch (e) { console.error('Fast Init Failed:', e); }
                    } else {
                        // If SDK script hasn't loaded (rare), wait for it
                        let attempts = 0;
                        const timer = setInterval(() => {
                            if (window.supabase) {
                                window.sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                                console.log('✅ Delayed Auth Client Initialized');
                                clearInterval(timer);
                            }
                            if (++attempts > 50) clearInterval(timer); // Stop after 5s
                        }, 100);
                    }
                })();

                function toggleAuthMode() {
                    isRegisterMode = !isRegisterMode;
                    const title = isRegisterMode ? "Join Morgan OS" : "Morgan OS";
                    const btnText = isRegisterMode ? "Create Account" : "Login";
                    const modeText = isRegisterMode ? "Already have an account?" : "Need an account?";
                    const toggleText = isRegisterMode ? "Login" : "Create Account";

                    document.querySelector('#auth-modal h1').innerText = title;
                    document.querySelector('#auth-submit-btn span').innerText = btnText;
                    document.getElementById('auth-mode-text').innerText = modeText;
                    document.getElementById('auth-toggle-btn').innerText = toggleText;

                    // Clear errors
                    document.getElementById('auth-error').classList.add('hidden');
                }

                async function handleAuthSubmit() {
                    if (isLoading) return;

                    const email = document.getElementById('auth-email').value;
                    const password = document.getElementById('auth-password').value;
                    const errorEl = document.getElementById('auth-error');
                    const submitBtn = document.getElementById('auth-submit-btn');
                    const btnSpan = submitBtn.querySelector('span');

                    if (!email || !password) {
                        showError('Please enter email and password');
                        return;
                    }

                    // Start Loading
                    isLoading = true;
                    submitBtn.classList.add('opacity-75', 'cursor-not-allowed');
                    const originalText = btnSpan.innerText;
                    btnSpan.innerText = isRegisterMode ? "Creating..." : "Verifying...";
                    errorEl.classList.add('hidden');

                    // ⏳ Timeout Guard (8s)
                    const timeoutPromise = new Promise((_, reject) =>
                        setTimeout(() => reject(new Error('Network Timeout (Firewall?). Click Sandbox Mode below 👇')), 8000)
                    );

                    try {
                        if (!window.sb) throw new Error('System initializing... please wait 1s');

                        let result;
                        if (isRegisterMode) {
                            // Register with Timeout
                            const authCall = window.sb.auth.signUp({ email, password });
                            result = await Promise.race([authCall, timeoutPromise]);

                            if (result.error) throw result.error;

                            if (result.data.user && !result.data.session) {
                                showError('✅ Reg Success! Please CHECK EMAIL to confirm.', 'text-green-400');
                                isLoading = false;
                                submitBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                                btnSpan.innerText = originalText;
                                return;
                            }
                            toggleAuthMode();
                        } else {
                            // Login with Timeout
                            const authCall = window.sb.auth.signInWithPassword({ email, password });
                            result = await Promise.race([authCall, timeoutPromise]);

                            if (result.error) throw result.error;
                            // Success handled by global listener
                        }
                    } catch (e) {
                        console.error("Auth Error:", e);
                        showError(e.message || 'Authentication Failed');

                        // Always show Sandbox Mode on ANY error/timeout to ensure user isn't stuck
                        const guestDiv = document.getElementById('guest-login-div');
                        if (guestDiv) guestDiv.classList.remove('hidden');

                    } finally {
                        isLoading = false;
                        submitBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                        btnSpan.innerText = originalText;
                    }
                }

                function handleGuestLogin() {
                    if (confirm('🔒 Enter Sandbox Mode?\n\nThis bypasses authentication for testing UI. Data is local-only.')) {
                        window.location.href = window.location.pathname + '?guest=true';
                    }
                }

                function showError(msg, colorClass = 'text-red-400') {
                    const el = document.getElementById('auth-error');
                    el.innerText = msg;
                    el.className = `p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-xs text-center font-medium ${colorClass}`;
                    el.classList.remove('hidden');
                }

                async function handleLogout() {
                    if (confirm('Ready to sign out?')) {
                        if (window.sb) {
                            await window.sb.auth.signOut();
                            location.reload();
                        }
                    }
                }
            </script>

            <!-- Cache Busting: v18.36 (Toast Fix) -->
            <script src="app.js?v=18.36" defer></script>
            <script>
                // Init Workflow Engine when tab is shown
                const originalShowTab = showTab;
                showTab = function (tabId) {
                    originalShowTab(tabId);
                    if (tabId === 'auto-flow') {
                        if (!window.FlowEngineInitialized) {
                            FlowEngine.init();
                            window.FlowEngineInitialized = true;
                        }
                    }
                }
            </script>
</body>

</html>