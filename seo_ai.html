<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEO AI å·¥ä½œç«™ - TDS Marketing OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-primary: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --bg-secondary: #1e293b;
            --bg-panel: rgba(30, 41, 59, 0.7);
            --text-primary: #e2e8f0;
            --text-secondary: #cbd5e1;
            --border-primary: #334155;
        }

        .light-mode {
            --bg-primary: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            --bg-secondary: #ffffff;
            --bg-panel: rgba(255, 255, 255, 0.9);
            --text-primary: #0f172a;
            --text-secondary: #1e293b;
            --border-primary: #e2e8f0;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s;
        }

        .input-box {
            width: 100%;
            padding: 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            color: var(--text-primary);
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .kb-doc-item {
            cursor: pointer;
            transition: all 0.2s;
        }

        .kb-doc-item:hover {
            transform: translateX(4px);
        }

        .kb-doc-item.selected {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6 !important;
        }

        #loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-4xl font-black mb-2" style="color: var(--text-primary);">
                    <span class="text-blue-500">ğŸ¤–</span> SEO AI å·¥ä½œç«™
                </h1>
                <p class="text-sm" style="color: var(--text-secondary);">æ™ºèƒ½æ–‡ç« ç”Ÿæˆ Â· AIæ£€æµ‹ Â· å»AIåº¦ä¼˜åŒ–</p>
            </div>
            <div class="flex gap-3">
                <button onclick="toggleTheme()" class="px-4 py-2 rounded-lg hover:bg-gray-700 transition">
                    <span id="theme-icon">ğŸŒ™</span>
                </button>
                <a href="index.html" class="px-4 py-2 rounded-lg hover:bg-blue-500 hover:bg-opacity-20 transition"
                    style="color: var(--text-secondary);">
                    â† è¿”å›ä¸»åº”ç”¨
                </a>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-12 gap-6">
            <!-- å·¦æ ï¼šæ™ºèƒ½å¼•ç”¨ (Smart Context) -->
            <div class="col-span-3">
                <div class="panel h-full flex flex-col">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2" style="color: var(--text-primary);">
                        <span>ğŸ§ </span> æ™ºèƒ½çŸ¥è¯†åº“å¼•ç”¨
                    </h3>

                    <div class="text-xs text-gray-500 mb-2">
                        æ ¹æ®ä¸»é¢˜è‡ªåŠ¨å¼•ç”¨å†…å®¹ï¼š
                    </div>

                    <div id="rag-context-list"
                        class="flex-1 space-y-2 overflow-y-auto mb-4 p-2 bg-black/20 rounded border border-gray-700">
                        <div class="text-center py-10 text-sm opacity-50">
                            <div class="text-2xl mb-2">âŒ¨ï¸</div>
                            è¾“å…¥æ–‡ç« ä¸»é¢˜<br>è‡ªåŠ¨æ£€ç´¢çŸ¥è¯†åº“
                        </div>
                    </div>

                    <div class="text-[10px] text-gray-500 text-center">
                        æ•°æ®æ¥æº: Local RAG Brain
                    </div>

                    <!-- API é…ç½® -->
                    <div class="mt-4 p-4 rounded"
                        style="background: var(--bg-secondary); border: 1px solid var(--border-primary);">
                        <h4 class="text-sm font-bold mb-3" style="color: var(--text-primary);">âš™ï¸ API é…ç½®</h4>
                        <input type="password" id="gemini-api-key" placeholder="Gemini API Key"
                            class="input-box text-xs mb-2">
                        <button onclick="saveApiKey()" class="btn-primary w-full text-xs">ğŸ’¾ ä¿å­˜</button>
                    </div>
                </div>
            </div>

            <!-- ä¸­æ ï¼šç”Ÿæˆæ§åˆ¶é¢æ¿ -->
            <div class="col-span-4">
                <div class="panel h-full">
                    <h3 class="text-lg font-bold mb-4" style="color: var(--text-primary);">ğŸ“ æ–‡ç« å‚æ•°</h3>

                    <div class="space-y-3">
                        <div>
                            <label class="text-xs font-bold mb-1 block"
                                style="color: var(--text-secondary);">æ–‡ç« ä¸»é¢˜</label>
                            <input type="text" id="article-topic" placeholder="ä¾‹ï¼šå¦‚ä½•é€‰æ‹©åˆé€‚çš„å·¥ä¸šè®¾å¤‡" class="input-box">
                        </div>

                        <div>
                            <label class="text-xs font-bold mb-1 block"
                                style="color: var(--text-secondary);">ç›®æ ‡å…³é”®è¯ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰</label>
                            <input type="text" id="article-keywords" placeholder="å·¥ä¸šè®¾å¤‡,é‡‡è´­æŒ‡å—,é€‰å‹" class="input-box">
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-bold mb-1 block"
                                    style="color: var(--text-secondary);">å­—æ•°</label>
                                <select id="article-length" class="input-box">
                                    <option value="800">800å­—</option>
                                    <option value="1200" selected>1200å­—</option>
                                    <option value="1500">1500å­—</option>
                                    <option value="2000">2000å­—</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-bold mb-1 block"
                                    style="color: var(--text-secondary);">å†™ä½œé£æ ¼</label>
                                <select id="article-style" class="input-box">
                                    <option value="professional">ä¸“ä¸š</option>
                                    <option value="casual">è½»æ¾</option>
                                    <option value="technical">æŠ€æœ¯</option>
                                </select>
                            </div>
                        </div>

                        <button onclick="generateSeoArticle()" class="btn-primary w-full mt-4" id="generate-btn">
                            <span id="generate-text">ğŸš€ ç”Ÿæˆ SEO æ–‡ç« </span>
                            <div id="loading-spinner" class="hidden mx-auto"></div>
                        </button>
                    </div>

                    <!-- SEO æ£€æŸ¥ç»“æœ -->
                    <div class="mt-6 p-4 rounded"
                        style="background: var(--bg-secondary); border: 1px solid var(--border-primary);">
                        <h4 class="text-sm font-bold mb-3" style="color: var(--text-primary);">ğŸ“Š SEO æ£€æŸ¥</h4>
                        <div id="seo-check-result" class="text-xs space-y-2" style="color: var(--text-secondary);">
                            <div class="flex justify-between">
                                <span>Hæ ‡ç­¾ç»“æ„:</span>
                                <span id="seo-h-tags">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span>å…³é”®è¯å¯†åº¦:</span>
                                <span id="seo-kw-density">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span>æ®µè½æ•°:</span>
                                <span id="seo-paragraphs">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span>æ€»å­—æ•°:</span>
                                <span id="seo-word-count">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³æ ï¼šç»“æœå±•ç¤ºä¸ä¼˜åŒ– -->
            <div class="col-span-5">
                <div class="panel h-full">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold" style="color: var(--text-primary);">ğŸ“„ ç”Ÿæˆç»“æœ</h3>
                        <div class="flex gap-2">
                            <button onclick="copyArticle()"
                                class="px-3 py-1 text-xs rounded hover:bg-blue-500 hover:bg-opacity-20"
                                style="color: var(--text-secondary);" title="å¤åˆ¶">
                                ğŸ“‹
                            </button>
                            <button onclick="downloadArticle()"
                                class="px-3 py-1 text-xs rounded hover:bg-blue-500 hover:bg-opacity-20"
                                style="color: var(--text-secondary);" title="ä¸‹è½½">
                                ğŸ’¾
                            </button>
                        </div>
                    </div>

                    <div id="article-output" class="p-4 rounded min-h-96 max-h-96 overflow-y-auto"
                        style="background: var(--bg-secondary); color: var(--text-secondary);">
                        <div class="text-center py-20 text-sm" style="color: var(--text-secondary);">
                            <div class="text-6xl mb-4">âœ¨</div>
                            ç­‰å¾…ç”Ÿæˆ...
                        </div>
                    </div>

                    <!-- AI æ£€æµ‹åŒº -->
                    <div class="mt-4 p-4 rounded"
                        style="background: var(--bg-secondary); border: 1px solid var(--border-primary);">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-sm font-bold" style="color: var(--text-primary);">ğŸ” AI åº¦æ£€æµ‹</span>
                            <button onclick="detectAI()"
                                class="px-3 py-1 text-xs rounded bg-blue-500 hover:bg-blue-600 text-white"
                                id="detect-btn">
                                å¼€å§‹æ£€æµ‹
                            </button>
                        </div>
                        <div class="flex items-center gap-4 mb-2">
                            <div class="flex-1">
                                <div class="w-full bg-gray-700 rounded-full h-6 overflow-hidden">
                                    <div id="ai-score-bar"
                                        class="h-full bg-gradient-to-r from-green-500 to-red-500 transition-all"
                                        style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="text-2xl font-black" id="ai-score-text" style="color: var(--text-primary);">--%
                            </div>
                        </div>
                        <div id="ai-score-advice" class="text-xs" style="color: var(--text-secondary);">ç­‰å¾…æ£€æµ‹...</div>
                    </div>

                    <!-- ä¼˜åŒ–æŒ‰é’® -->
                    <button onclick="optimizeArticle()" class="btn-primary w-full mt-4" id="optimize-btn" disabled>
                        âš¡ ä¼˜åŒ–å» AI åº¦
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentArticle = '';
        let geminiApiKey = localStorage.getItem('tds_gemini_api_key') || '';

        // RAG State
        let kbChunks = [];
        const KB_STORAGE_KEY = 'morgan_kb_chunks';

        // ä¸»é¢˜åˆ‡æ¢
        function toggleTheme() {
            const body = document.body;
            const isLight = body.classList.contains('light-mode');
            if (isLight) {
                body.classList.remove('light-mode');
                document.getElementById('theme-icon').innerText = 'ğŸŒ™';
                localStorage.setItem('seo_ai_theme', 'dark');
            } else {
                body.classList.add('light-mode');
                document.getElementById('theme-icon').innerText = 'â˜€ï¸';
                localStorage.setItem('seo_ai_theme', 'light');
            }
        }

        function loadTheme() {
            if (localStorage.getItem('seo_ai_theme') === 'light') {
                document.body.classList.add('light-mode');
                document.getElementById('theme-icon').innerText = 'â˜€ï¸';
            }
            if (geminiApiKey) {
                document.getElementById('gemini-api-key').value = geminiApiKey;
            }
        }

        // --- RAG Logic ---

        function initRAG() {
            const stored = localStorage.getItem(KB_STORAGE_KEY);
            if (stored) kbChunks = JSON.parse(stored);

            // Auto retrieve if topic exists
            document.getElementById('article-topic').addEventListener('input', (e) => {
                updateRAGContext(e.target.value);
            });
        }

        function updateRAGContext(topic) {
            const container = document.getElementById('rag-context-list');
            if (!topic || topic.length < 2) {
                container.innerHTML = '<div class="text-center py-10 text-sm opacity-50"><div class="text-2xl mb-2">âŒ¨ï¸</div>è¾“å…¥æ–‡ç« ä¸»é¢˜<br>è‡ªåŠ¨æ£€ç´¢çŸ¥è¯†åº“</div>';
                return;
            }

            const context = retrieveContext(topic); // Use simple retrieval

            if (context.length === 0) {
                container.innerHTML = '<div class="text-center py-10 text-sm opacity-50">æ— ç›¸å…³çŸ¥è¯†åº“å†…å®¹</div>';
                return;
            }

            container.innerHTML = context.map(c => `
                <div class="p-2 bg-gray-800 rounded border border-gray-700 hover:border-blue-500/50 transition-colors text-[10px]">
                    <div class="flex justify-between text-gray-400 mb-1">
                        <span class="truncate w-24">${c.source}</span>
                        <span class="text-green-500">Match: ${c.score}</span>
                    </div>
                    <div class="text-gray-300 line-clamp-2">"${c.content}"</div>
                </div>
            `).join('');
        }

        function retrieveContext(query) {
            if (kbChunks.length === 0) return [];
            const qTokens = query.toLowerCase().split(/\s+/).filter(w => w.length > 1);

            const scored = kbChunks.map(chunk => {
                let score = 0;
                const text = chunk.content.toLowerCase();
                qTokens.forEach(t => { if (text.includes(t)) score += 1; });
                return { ...chunk, score };
            });

            return scored.filter(c => c.score > 0).sort((a, b) => b.score - a.score).slice(0, 10);
        }

        // ä¿å­˜ API Key
        function saveApiKey() {
            geminiApiKey = document.getElementById('gemini-api-key').value.trim();
            if (geminiApiKey) {
                localStorage.setItem('tds_gemini_api_key', geminiApiKey);
                alert('âœ… API Key å·²ä¿å­˜');
            } else {
                alert('âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„ API Key');
            }
        }

        // ç”Ÿæˆ SEO æ–‡ç« 
        async function generateSeoArticle() {
            const topic = document.getElementById('article-topic').value.trim();
            const keywords = document.getElementById('article-keywords').value.trim();
            const length = document.getElementById('article-length').value;
            const style = document.getElementById('article-style').value;

            if (!topic) {
                alert('âŒ è¯·è¾“å…¥æ–‡ç« ä¸»é¢˜');
                return;
            }

            if (!geminiApiKey) {
                alert('âŒ è¯·å…ˆé…ç½® Gemini API Key');
                return;
            }

            // RAG Context Retrieval
            const contextChunks = retrieveContext(topic + " " + keywords);
            const contextText = contextChunks.map(c => c.content).join('\n\n');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const generateBtn = document.getElementById('generate-btn');
            const generateText = document.getElementById('generate-text');
            const loadingSpinner = document.getElementById('loading-spinner');
            generateBtn.disabled = true;
            generateText.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');

            try {
                const prompt = buildSeoPrompt(topic, keywords, length, style, contextText);
                const article = await callGeminiAPI(prompt);

                if (article) {
                    currentArticle = article;
                    displayArticle(article);
                    analyzeSEO(article, keywords);
                    document.getElementById('detect-btn').disabled = false;
                }
            } catch (error) {
                alert('âŒ ç”Ÿæˆå¤±è´¥: ' + error.message);
                console.error(error);
            } finally {
                generateBtn.disabled = false;
                generateText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        }

        function buildSeoPrompt(topic, keywords, length, style, reference) {
            const styleMap = {
                'professional': 'ä¸“ä¸šã€ä¸¥è°¨',
                'casual': 'è½»æ¾ã€æ˜“æ‡‚',
                'technical': 'æŠ€æœ¯æ€§ã€è¯¦ç»†'
            };

            let prompt = `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„SEOå†…å®¹ä½œå®¶ã€‚è¯·æ’°å†™ä¸€ç¯‡ç¬¦åˆGoogle SEOè§„èŒƒçš„æ–‡ç« ã€‚

**è¦æ±‚ï¼š**
1. ä¸»é¢˜ï¼š${topic}
2. ç›®æ ‡å…³é”®è¯ï¼š${keywords}
3. å­—æ•°ï¼šçº¦${length}å­—
4. å†™ä½œé£æ ¼ï¼š${styleMap[style]}
5. å¿…é¡»åŒ…å«æ¸…æ™°çš„æ ‡é¢˜å±‚çº§ï¼ˆH1, H2, H3ï¼‰
6. å…³é”®è¯å¯†åº¦æ§åˆ¶åœ¨2-3%
7. æ¯ä¸ªæ®µè½ä¸è¶…è¿‡150å­—
8. å†…å®¹è¦æœ‰ä»·å€¼ã€åŸåˆ›æ€§å¼º
9. é€‚å½“ä½¿ç”¨åˆ—è¡¨å’Œè¦ç‚¹

`;

            if (reference && reference.length > 50) {
                prompt += `\n**[CRITICAL] å¿…é¡»åŸºäºä»¥ä¸‹äº§å“çŸ¥è¯†åº“å†…å®¹æ’°å†™ï¼Œä¸¥ç¦åŒ…å«ä»»ä½•è™šå‡å‚æ•°ï¼š**\n"""\n${reference.substring(0, 5000)}\n"""\n\n`;
            } else {
                prompt += `\n(æ³¨æ„ï¼šçŸ¥è¯†åº“ä¸­æœªæ‰¾åˆ°ç›¸å…³èµ„æ–™ï¼Œè¯·åŸºäºç½‘è·¯é€šç”¨çŸ¥è¯†æ’°å†™ï¼Œä½†ä¸è¦æé€ å…·ä½“å‚æ•°)\n`;
            }

            prompt += `è¯·ç›´æ¥è¾“å‡ºæ–‡ç« å†…å®¹ï¼Œä½¿ç”¨Markdownæ ¼å¼ï¼ŒåŒ…å«æ ‡é¢˜ç»“æ„ã€‚`;

            return prompt;
        }

        async function callGeminiAPI(prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${geminiApiKey}`;

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        maxOutputTokens: 2048,
                    }
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'API è°ƒç”¨å¤±è´¥');
            }

            const data = await response.json();
            return data.candidates[0]?.content?.parts[0]?.text || '';
        }

        function displayArticle(article) {
            document.getElementById('article-output').innerHTML = `
                <div class="prose prose-invert max-w-none" style="color: var(--text-secondary);">
                    ${marked(article)}
                </div>
            `;
        }

        // ç®€å•çš„ Markdown æ¸²æŸ“ï¼ˆåŸºç¡€ç‰ˆï¼‰
        function marked(text) {
            return text
                .replace(/^### (.*$)/gim, '<h3 class="text-lg font-bold mt-4 mb-2">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 class="text-xl font-bold mt-6 mb-3">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 class="text-2xl font-black mt-8 mb-4">$1</h1>')
                .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
                .replace(/\*(.*)\*/gim, '<em>$1</em>')
                .replace(/\n\n/g, '</p><p class="mb-3">')
                .replace(/^/gim, '<p class="mb-3">')
                .replace(/$/, '</p>');
        }

        // SEO åˆ†æ
        function analyzeSEO(article, keywords) {
            const text = article.replace(/#/g, '').replace(/\*/g, '');

            // Hæ ‡ç­¾ç»Ÿè®¡
            const h1Count = (article.match(/^# /gm) || []).length;
            const h2Count = (article.match(/^## /gm) || []).length;
            const h3Count = (article.match(/^### /gm) || []).length;
            document.getElementById('seo-h-tags').innerText = `H1:${h1Count} H2:${h2Count} H3:${h3Count}`;

            // å…³é”®è¯å¯†åº¦
            if (keywords) {
                const kwArray = keywords.split(/[,ï¼Œ]/);
                let totalKw = 0;
                kwArray.forEach(kw => {
                    const regex = new RegExp(kw.trim(), 'gi');
                    const matches = text.match(regex) || [];
                    totalKw += matches.length;
                });
                const wordCount = text.length;
                const density = ((totalKw / wordCount) * 100).toFixed(2);
                document.getElementById('seo-kw-density').innerText = density + '%';
            }

            // æ®µè½æ•°
            const paragraphs = text.split('\n\n').filter(p => p.trim().length > 0).length;
            document.getElementById('seo-paragraphs').innerText = paragraphs;

            // æ€»å­—æ•°
            document.getElementById('seo-word-count').innerText = text.length;
        }

        // AI æ£€æµ‹
        function detectAI() {
            if (!currentArticle) {
                alert('è¯·å…ˆç”Ÿæˆæ–‡ç« ');
                return;
            }

            const aiScore = calculateAIScore(currentArticle);

            // æ›´æ–°è¿›åº¦æ¡
            document.getElementById('ai-score-bar').style.width = aiScore + '%';
            document.getElementById('ai-score-text').innerText = aiScore + '%';

            // ç»™å‡ºå»ºè®®
            let advice = '';
            if (aiScore < 30) {
                advice = 'âœ… ä¼˜ç§€ - å†…å®¹è‡ªç„¶åº¦å¾ˆé«˜';
                document.getElementById('optimize-btn').disabled = true;
            } else if (aiScore < 60) {
                advice = 'âš ï¸ ä¸­ç­‰ - å»ºè®®è¿›è¡Œä¼˜åŒ–';
                document.getElementById('optimize-btn').disabled = false;
            } else {
                advice = 'ğŸš¨ è¾ƒé«˜ - å¼ºçƒˆå»ºè®®ä¼˜åŒ–';
                document.getElementById('optimize-btn').disabled = false;
            }
            document.getElementById('ai-score-advice').innerText = advice;
        }

        function calculateAIScore(text) {
            let score = 0;

            // 1. æ£€æµ‹AIå¸¸ç”¨çŸ­è¯­
            const aiPhrases = [
                'é‡è¦çš„æ˜¯', 'å€¼å¾—æ³¨æ„', 'æ­¤å¤–', 'ç„¶è€Œ', 'å› æ­¤', 'æ€»ä¹‹',
                'ç»¼ä¸Šæ‰€è¿°', 'é¦–å…ˆ', 'å…¶æ¬¡', 'æœ€å', 'å¦å¤–'
            ];
            aiPhrases.forEach(phrase => {
                const count = (text.match(new RegExp(phrase, 'g')) || []).length;
                score += count * 5;
            });

            // 2. æ£€æµ‹å¥å­é•¿åº¦ä¸€è‡´æ€§
            const sentences = text.split(/[ã€‚ï¼ï¼Ÿ.!?]/);
            const lengths = sentences.map(s => s.length);
            const avg = lengths.reduce((a, b) => a + b, 0) / lengths.length;
            const variance = lengths.reduce((sum, len) => sum + Math.pow(len - avg, 2), 0) / lengths.length;
            if (variance < 50) score += 20; // é•¿åº¦è¿‡äºä¸€è‡´

            // 3. æ£€æµ‹è¯æ±‡å¤šæ ·æ€§
            const words = text.split(/\s+/);
            const uniqueWords = new Set(words);
            const diversity = uniqueWords.size / words.length;
            if (diversity < 0.4) score += 15; // è¯æ±‡é‡å¤åº¦é«˜

            // 4. æ£€æµ‹è¿‡åº¦æ­£å¼
            const formalMarkers = ['é‰´äº', 'åŸºäº', 'æ—¨åœ¨', 'è‡´åŠ›äº', 'æœ‰æ•ˆåœ°'];
            formalMarkers.forEach(marker => {
                if (text.includes(marker)) score += 3;
            });

            return Math.min(100, Math.max(0, score));
        }

        // ä¼˜åŒ–æ–‡ç« 
        async function optimizeArticle() {
            if (!currentArticle) {
                alert('è¯·å…ˆç”Ÿæˆæ–‡ç« ');
                return;
            }

            if (!geminiApiKey) {
                alert('âŒ è¯·å…ˆé…ç½® Gemini API Key');
                return;
            }

            const optimizeBtn = document.getElementById('optimize-btn');
            optimizeBtn.disabled = true;
            optimizeBtn.innerText = 'â³ ä¼˜åŒ–ä¸­...';

            try {
                const optimizedPrompt = `è¯·ä¼˜åŒ–ä»¥ä¸‹æ–‡ç« ï¼Œä½¿å…¶æ›´å…·äººæ€§åŒ–å’Œè‡ªç„¶æ€§ã€‚è¦æ±‚ï¼š
1. ä¿æŒåŸæ„å’ŒSEOå…³é”®è¯
2. å¢åŠ å£è¯­åŒ–è¡¨è¾¾
3. æ‰“ç ´å¥å­ç»“æ„çš„è§„å¾‹æ€§
4. æ·»åŠ ä¸€äº›ä¸ªäººè§‚ç‚¹æˆ–ä¾‹å­
5. é€‚å½“ä½¿ç”¨ä¸åŒé•¿åº¦çš„å¥å­

åŸæ–‡ï¼š
${currentArticle}

è¯·ç›´æ¥è¾“å‡ºä¼˜åŒ–åçš„å†…å®¹ï¼Œä½¿ç”¨ç›¸åŒçš„Markdownæ ¼å¼ã€‚`;

                const optimized = await callGeminiAPI(optimizedPrompt);

                if (optimized) {
                    currentArticle = optimized;
                    displayArticle(optimized);
                    alert('âœ… ä¼˜åŒ–å®Œæˆï¼è¯·é‡æ–°æ£€æµ‹AIåº¦');
                }
            } catch (error) {
                alert('âŒ ä¼˜åŒ–å¤±è´¥: ' + error.message);
                console.error(error);
            } finally {
                optimizeBtn.disabled = false;
                optimizeBtn.innerText = 'âš¡ ä¼˜åŒ–å» AI åº¦';
            }
        }

        // å¤åˆ¶æ–‡ç« 
        function copyArticle() {
            if (!currentArticle) {
                alert('æš‚æ— å†…å®¹å¯å¤åˆ¶');
                return;
            }
            navigator.clipboard.writeText(currentArticle).then(() => {
                alert('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            });
        }

        // ä¸‹è½½æ–‡ç« 
        function downloadArticle() {
            if (!currentArticle) {
                alert('æš‚æ— å†…å®¹å¯ä¸‹è½½');
                return;
            }
            const blob = new Blob([currentArticle], { type: 'text/markdown' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `seo_article_${new Date().toISOString().split('T')[0]}.md`;
            a.click();
        }

        // åˆå§‹åŒ–
        window.onload = function () {
            loadTheme();
            initRAG();
        };
    </script>
</body>

</html>